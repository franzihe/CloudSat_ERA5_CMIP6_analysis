

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Example with CMIP6 models (100 - 500 km) &#8212; globalsnow</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cmip/CMIP6_daily_2006-2009';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="globalsnow - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="globalsnow - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to Global Snow project website
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ERA5/ERA5_1985-2014.html">Example with ERA5 high-resolution (~0.25deg) monthly means</a></li>






<li class="toctree-l1"><a class="reference internal" href="CMIP6_hr_1985-2014.html">Example with CMIP6 models (100 - 500 km)</a></li>








<li class="toctree-l1 has-children"><a class="reference internal" href="../cloudsat.html">Cloudsat</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../CloudSat/get_pressure_grid.html">Example to get CloudSat mean pressure level profile</a></li>



<li class="toctree-l2"><a class="reference internal" href="../CloudSat/read_2C_snow.html">Regrid CloudSat data to horizontal grid</a></li>



</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/franzihe/CloudSat_ERA5_CMIP6_analysis" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/franzihe/CloudSat_ERA5_CMIP6_analysis/issues/new?title=Issue%20on%20page%20%2Fcmip/CMIP6_daily_2006-2009.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/cmip/CMIP6_daily_2006-2009.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example with CMIP6 models (100 - 500 km)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Example with CMIP6 models (100 - 500 km)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-introduction-a">1. Introduction <a id="introduction"></a></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#data-wrangling-a-id-data-wrangling-a">2. Data Wrangling <a id="data_wrangling"></a></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organize-my-data">Organize my data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-python-packages">Import python packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#open-cmip6-variables">Open CMIP6 variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#search-corresponding-data">Search corresponding data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-attributes-to-the-variables">Assign attributes to the variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels">Interpolate from CMIP6 hybrid sigma-pressure levels to isobaric pressure levels</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-liquid-water-path-from-content">Calculate liquid water path from content</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#regrid-cmip6-data-to-ipsl-cm6a-lr-and-ipsl-cm5a2-inca-grid-a-id-regrid-hz-a">Regrid CMIP6 data to IPSL-CM6A-LR and IPSL-CM5A2-INCA grid <a id="regrid_hz"></a></a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># export PYTHONPATH=&quot;${PYTHONPATH}:/uio/kant/geo-geofag-u1/franzihe/Documents/Python/globalsnow/CloudSat_ERA5_CMIP6_analysis/utils/&quot;</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="example-with-cmip6-models-100-500-km">
<h1>Example with CMIP6 models (100 - 500 km)<a class="headerlink" href="#example-with-cmip6-models-100-500-km" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="table-of-contents">
<h1>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h1>
<ul>
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#data_wrangling">2. Data Wrangling</a></li>
<li><a href="#exploratory">3. Exploratory Data Analysis</a></li>
<li><a href="#conclusion">4. Conclusion</a></li>
<li><a href="#references">5. References</a></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction-a-id-introduction-a">
<h1>1. Introduction <a id='introduction'></a><a class="headerlink" href="#introduction-a-id-introduction-a" title="Permalink to this heading">#</a></h1>
<p>Cloud feedbacks are a major contributor to the spread of climate sensitivity in global climate models (GCMs) <a class="reference external" href="https://doi-org.ezproxy.uio.no/10.1029/2019GL085782">Zelinka et al. (2020)</a>. Among the most poorly understood cloud feedbacks is the one associated with the cloud phase, which is expected to be modified with climate change <a class="reference external" href="https://doi-org.ezproxy.uio.no/10.1038/s41561-020-00649-1">Bjordal et al. (2020)</a>. Cloud phase bias, in addition, has significant implications for the simulation of radiative properties and glacier and ice sheet mass balances in climate models.</p>
<p>In this context, this work aims to expand our knowledge on how the representation of the cloud phase affects snow formation in GCMs. Better understanding this aspect is necessary to develop climate models further and improve future climate predictions.</p>
<ul class="simple">
<li><p>Retrieve CMIP6 data through <a class="reference external" href="https://esgf-node.llnl.gov/search/cmip6/">ESGF</a></p></li>
<li><p>Hybrid sigma-pressure coordinates to isobaric pressure levels of the European Centre for Medium-Range Weather Forecast Re-Analysis 5 (ERA5) with <a class="reference external" href="https://geocat-comp.readthedocs.io/en/latest/index.html">GeoCAT-comb</a></p></li>
<li><p>Regridd the CMIP6 variables to the exact horizontal resolution with <a class="reference external" href="https://xesmf.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">xesmf</span></code></a></p></li>
<li><p>Calculate an ensemble mean of all used models</p></li>
<li><p>Calculate and plot the seasonal mean of the ensemble mean</p></li>
</ul>
<p><strong>Questions</strong></p>
<ul class="simple">
<li><p>How is the cloud phase and snowfall varying between 2007 and 2010?</p></li>
</ul>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> We answer questions related to the comparison of CMIP models to ERA5 in another <span class="xref myst">Jupyter Notebook</span>.</p>
</div></blockquote>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="data-wrangling-a-id-data-wrangling-a">
<h1>2. Data Wrangling <a id='data_wrangling'></a><a class="headerlink" href="#data-wrangling-a-id-data-wrangling-a" title="Permalink to this heading">#</a></h1>
<p>This study will compare surface snowfall, ice, and liquid water content from the Coupled Model Intercomparison Project Phase 6 (<a class="reference external" href="https://esgf-node.llnl.gov/projects/cmip6/">CMIP6</a>) climate models to the European Centre for Medium-Range Weather Forecast Re-Analysis 5 (<a class="reference external" href="https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5">ERA5</a>) data from <strong>2006 to 2009</strong>. We conduct statistical analysis at the annual and seasonal timescales to determine the biases in cloud phase and precipitation (liquid and solid) in the CMIP6 models and their potential connection between them.</p>
<ul class="simple">
<li><p>Time period: 2006 to 2009</p></li>
<li><p>horizonal resolution: depending on model</p></li>
<li><p>time resolution: daily mean atmospheric data (CFday, day)</p></li>
<li><p>Variables:</p></li>
</ul>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>shortname</p></th>
<th class="head text-center"><p>Long name</p></th>
<th class="head text-right"><p>Units</p></th>
<th class="head text-right"><p>levels</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>prsn</p></td>
<td class="text-center"><p>Snowfall Flux</p></td>
<td class="text-right"><p>[kg m-2 s-1]</p></td>
<td class="text-right"><p>surface</p></td>
</tr>
<tr class="row-odd"><td><p>clw</p></td>
<td class="text-center"><p>Mass Fraction of Cloud Liquid Water</p></td>
<td class="text-right"><p>[kg kg-1]</p></td>
<td class="text-right"><p>ml</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td class="text-center"><p></p></td>
<td class="text-right"><p>to calculate lwp use integral clw -dp/dg</p></td>
<td class="text-right"><p></p></td>
</tr>
<tr class="row-odd"><td><p>tas</p></td>
<td class="text-center"><p>Near-Surface Air Temperature</p></td>
<td class="text-right"><p>[K]</p></td>
<td class="text-right"><p>surface</p></td>
</tr>
<tr class="row-even"><td><p>clivi</p></td>
<td class="text-center"><p>Ice Water Path</p></td>
<td class="text-right"><p>[kg m-2]</p></td>
<td class="text-right"><p></p></td>
</tr>
<tr class="row-odd"><td><p>lwp</p></td>
<td class="text-center"><p>Liquid Water Path</p></td>
<td class="text-right"><p>[kg m-2]</p></td>
<td class="text-right"><p></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>CMIP6 models:</p></li>
</ul>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Institution</p></th>
<th class="head text-center"><p>Model name</p></th>
<th class="head text-right"><p>Reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="xref myst">MIROC</span></p></td>
<td class="text-center"><p>MIROC6</p></td>
<td class="text-right"><p><span class="xref myst">Tatebe et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">NCAR</span></p></td>
<td class="text-center"><p>CESM2</p></td>
<td class="text-right"><p><span class="xref myst">Danabasoglu et al. (2020)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">CCCma</span></p></td>
<td class="text-center"><p>CanESM5</p></td>
<td class="text-right"><p><span class="xref myst">Swart et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">AWI</span></p></td>
<td class="text-center"><p>AWI-ESM-1-1-LR</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst"></span></p></td>
<td class="text-center"><p>MPI-ESM1-2-LR</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">MOHC</span></p></td>
<td class="text-center"><p>UKESM1-0-LL</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">MOHC</span></p></td>
<td class="text-center"><p>HadGem3-GC31-LL</p></td>
<td class="text-right"><p><span class="xref myst">Roberts et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">CNRM-CERFACS</span></p></td>
<td class="text-center"><p>CNRM-CM6-1</p></td>
<td class="text-right"><p><span class="xref myst">Voldoire et al. (2019)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">CNRM-CERFACS</span></p></td>
<td class="text-center"><p>CNRM-ESM2-1</p></td>
<td class="text-right"><p><span class="xref myst">Seferian et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">IPSL</span></p></td>
<td class="text-center"><p>IPSL-CM6A-LR</p></td>
<td class="text-right"><p><span class="xref myst">Boucher et al. (2020)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">IPSL</span></p></td>
<td class="text-center"><p>IPSL-CM5A2-INCA</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
</tbody>
</table>
<section id="organize-my-data">
<h2>Organize my data<a class="headerlink" href="#organize-my-data" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Define a prefix for my project (you may need to adjust it for your own usage on your infrastructure).</p>
<ul>
<li><p>input folder where all the data used as input to my Jupyter Notebook is stored (and eventually shared)</p></li>
<li><p>output folder where all the results to keep are stored</p></li>
<li><p>tool folder where all the tools</p></li>
</ul>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">/input/cmip6_hist/daily_means</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

<span class="n">abs_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
<span class="n">WORKDIR</span> <span class="o">=</span> <span class="n">abs_path</span><span class="p">[:</span><span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abs_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>


<span class="k">if</span> <span class="s2">&quot;mimi&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/scratch/franzihe/&quot;</span>
<span class="k">elif</span> <span class="s2">&quot;glefsekaldt&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span> 
    <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/home/franzihe/Data/&quot;</span>

<span class="n">INPUT_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
<span class="n">OUTPUT_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
<span class="n">UTILS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">,</span> <span class="s1">&#39;utils/&#39;</span><span class="p">)</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UTILS_DIR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mimi.uio.no
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-python-packages">
<h2>Import python packages<a class="headerlink" href="#import-python-packages" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Python</span></code> environment requirements: file <a class="reference download internal" download="" href="../_downloads/06f3f4f78bf14ffb9f9cfdf395203c3c/requirements_globalsnow.txt"><span class="xref download myst">requirements_globalsnow.txt</span></a></p></li>
<li><p>load <code class="docutils literal notranslate"><span class="pre">python</span></code> packages from <a class="reference download internal" download="" href="../_downloads/5eb7796ec8541cded4dcee2282ad687a/imports.py"><span class="xref download myst">imports.py</span></a></p></li>
<li><p>load <code class="docutils literal notranslate"><span class="pre">functions</span></code> from <a class="reference download internal" download="" href="../_downloads/3afa0d66b1ce4f3999c315ad3a2e691d/functions.py"><span class="xref download myst">functions.py</span></a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># supress warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1"># don&#39;t output warnings</span>

<span class="c1"># import packages</span>
<span class="kn">from</span> <span class="nn">imports</span> <span class="kn">import</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">intake</span><span class="p">,</span> <span class="n">cftime</span><span class="p">,</span> <span class="n">xe</span><span class="p">,</span> <span class="n">glob</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">fct</span><span class="p">,</span><span class="n">ccrs</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">distributed</span><span class="p">,)</span><span class="c1"># dask)</span>
<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">display_style</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.core.options.set_options at 0x7f07824061a0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reload imports</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a client for distributed computing with dask</span>
<span class="c1"># client = dask.distributed.Client()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="open-cmip6-variables">
<h2>Open CMIP6 variables<a class="headerlink" href="#open-cmip6-variables" title="Permalink to this heading">#</a></h2>
<p>Get the data required for the analysis. Beforehand we downloaded the daily averaged data on single levels and model levels via.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmip_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT_DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;cmip6_hist/&#39;</span><span class="p">)</span>



<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="s1">&#39;common_grid&#39;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="s1">&#39;single_model&#39;</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variable_id</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">,</span> <span class="s1">&#39;cli&#39;</span><span class="p">,</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;prsn&#39;</span><span class="p">,</span> <span class="s1">&#39;pr&#39;</span><span class="p">,</span> <span class="s1">&#39;pfull&#39;</span><span class="p">,</span> <span class="s1">&#39;phalf&#39;</span><span class="p">,</span>  <span class="s1">&#39;areacella&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>At the moment we have downloaded the end of the historical simulations for CMIP6 models. We define start and end year to ensure to only extract the 4-year period between 2006 and 2009.</p>
<p><span class="math notranslate nohighlight">\(\rightarrow\)</span> Define a start and end year</p>
<p>We will load all available models into one dictonary, which includes an xarray dataset with <code class="docutils literal notranslate"><span class="pre">xarray.open_mfdataset(file)</span></code> and select the time range <a class="reference external" href="https://xarray.pydata.org/en/stable/user-guide/indexing.html">by name</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># source_id</span>
<span class="n">list_models</span> <span class="o">=</span> <span class="p">[</span>
               <span class="c1"># &#39;MIROC6&#39;, #area</span>
               <span class="c1"># # &#39;CESM2&#39;, #area # this model has snowfall only over land</span>
               <span class="c1"># &#39;CanESM5&#39;, # area</span>
               <span class="c1"># &#39;AWI-ESM-1-1-LR&#39;, # area</span>
               <span class="c1"># &#39;MPI-ESM1-2-LR&#39;, # area</span>
               <span class="c1"># &#39;UKESM1-0-LL&#39;, </span>
               <span class="c1"># &#39;HadGEM3-GC31-LL&#39;,</span>
               <span class="c1"># &#39;CNRM-CM6-1&#39;, #area</span>
               <span class="s1">&#39;CNRM-ESM2-1&#39;</span><span class="p">,</span> <span class="c1">#area</span>
               <span class="c1"># &#39;IPSL-CM6A-LR&#39;, #area</span>
               <span class="c1"># &#39;IPSL-CM5A2-INCA&#39; #area</span>
            <span class="p">]</span>

<span class="c1">## experiment</span>
<span class="n">experiment_id</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;historical&#39;</span><span class="p">]</span>

<span class="c1">## time resolution</span>
<span class="n">t_res</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">,]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="search-corresponding-data">
<h2>Search corresponding data<a class="headerlink" href="#search-corresponding-data" title="Permalink to this heading">#</a></h2>
<p>Get the data required for the analysis. Define variables, models, experiment, and time resolution as defined in <a href="#data_wrangling">2. Data Wrangling</a>
.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">open_ds_var_id</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">year_range</span><span class="p">,</span> <span class="n">var_id</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
            <span class="n">ds_var_id</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">drop_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prsn&#39;</span><span class="p">])</span>
            
        <span class="k">elif</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;ta&#39;</span><span class="p">:</span>
            <span class="n">ds_var_id</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">drop_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;phalf&#39;</span><span class="p">:</span>
            <span class="n">ds_var_id</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="n">drop_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;orog&#39;</span><span class="p">,</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span><span class="s1">&#39;ap&#39;</span><span class="p">,</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">,])</span>
            <span class="c1"># if model == &#39;IPSL-CM6A-LR&#39;:</span>
            <span class="c1">#     ds_var_id = ds_var_id.assign_coords({&#39;presnivs&#39;: ds_var_id[&#39;klev&#39;].data})</span>
            <span class="c1">#     ds_var_id = ds_var_id.drop_dims({&#39;klev&#39;}).rename({&#39;presnivs&#39;:&#39;klev&#39;})</span>
                
            <span class="c1">#     # ds_var_id = ds_var_id.rename({&#39;presnivs&#39;:&#39;half_lev&#39;,})</span>
            <span class="c1"># #     </span>
            <span class="c1"># else:</span>
            <span class="n">ds_var_id</span> <span class="o">=</span> <span class="n">ds_var_id</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;lev&#39;</span><span class="p">:</span><span class="s1">&#39;half_lev&#39;</span><span class="p">,</span><span class="s1">&#39;lev_bnds&#39;</span><span class="p">:</span><span class="s1">&#39;half_lev_bnds&#39;</span><span class="p">})</span>
        
           
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds_var_id</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="c1"># select only years needed for analysis</span>
        <span class="n">ds_var_id</span> <span class="o">=</span> <span class="n">ds_var_id</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ds_var_id</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">year_range</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        
        
            
        <span class="k">if</span> <span class="n">var_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds_var_id</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1"> do not exists in </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ds_var_id[var_id] = ds_var_id[var_id].where(ds_var_id[var_id] &gt;= 0.)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">ds_var_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no files found for </span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>We can call dask.delayed on our funtions to make them lazy. Rather than compute their results immediately, they record what we want to compute as a task into a graph that we’ll run later on parallel hardware.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>    
<span class="k">def</span> <span class="nf">search_data</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">experiment_id</span><span class="p">,</span><span class="n">variable_id</span><span class="p">,</span> <span class="n">year_range</span><span class="p">,</span> <span class="n">variant_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;CNRM-CM6-1&#39;</span><span class="p">:</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">cmip_in</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;single_model/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_*</span><span class="si">{</span><span class="n">t_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variant_label</span><span class="si">}</span><span class="s2">*&quot;</span>
        <span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">cmip_in</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;single_model/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_*</span><span class="si">{</span><span class="n">t_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">*&quot;</span>
        <span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">]</span>
    
    
    <span class="c1"># file_paths = (dask.delayed(glob)(file_path) for file_path in file_paths)</span>
    <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">glob</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">]</span>
    
    <span class="c1"># ds_clw, ds_cli, ds_clivi, ds_tas, ds_prsn, ds_pr, ds_pfull, ds_ta = ([</span>
    <span class="c1">#     dask.delayed(open_ds_var_id)(files, year_range, var_id)</span>
    <span class="c1">#     for files, var_id in zip(file_paths, variable_id)</span>
    <span class="c1"># ])</span>
    <span class="n">ds_clw</span><span class="p">,</span> <span class="n">ds_cli</span><span class="p">,</span> <span class="n">ds_clivi</span><span class="p">,</span> <span class="n">ds_tas</span><span class="p">,</span> <span class="n">ds_prsn</span><span class="p">,</span> <span class="n">ds_pr</span><span class="p">,</span> <span class="n">ds_pfull</span><span class="p">,</span> <span class="n">ds_phalf</span> <span class="o">=</span> <span class="p">([</span>
        <span class="n">open_ds_var_id</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">year_range</span><span class="p">,</span> <span class="n">var_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">files</span><span class="p">,</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">variable_id</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds_clw</span><span class="p">,</span> <span class="n">ds_cli</span><span class="p">,</span> <span class="n">ds_clivi</span><span class="p">,</span> <span class="n">ds_tas</span><span class="p">,</span> <span class="n">ds_prsn</span><span class="p">,</span> <span class="n">ds_pr</span><span class="p">,</span> <span class="n">ds_pfull</span><span class="p">,</span> <span class="n">ds_phalf</span><span class="p">]</span>
    
        
    
    <span class="c1"># Combine datasets by coordinates</span>
    <span class="c1"># dset = dask.delayed(xr.combine_by_coords)([ds for ds in dsets])</span>
    <span class="n">dset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">([</span><span class="n">ds</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dsets</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">combine_attrs</span> <span class="o">=</span><span class="s1">&#39;drop_conflicts&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds_pfull</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># sort to start at the top of the atmosphere</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">lev</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">half_lev</span><span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">half_lev</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds_areacella</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmip_in</span><span class="si">}</span><span class="s2">/single_model/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">/areacella_fx_*</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">*.nc&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="c1">#drop_variables=[&quot;lat_bnds&quot;, &quot;lon_bnds&quot;],</span>
        <span class="p">)</span>
        <span class="c1"># dset = xr.merge([dset, ds_areacella])</span>
        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;areacella&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_areacella</span><span class="p">[</span><span class="s1">&#39;areacella&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;areacella does not exist in </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="c1"># shift longitude to be from -180 to 180</span>
    <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">(((</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">drop</span><span class="p">({</span><span class="s1">&#39;height&#39;</span><span class="p">})</span>
    
    <span class="c1"># dset = dset.transpose(&#39;time&#39;, &#39;lat&#39;, &#39;lon&#39;, &#39;lev&#39;, ...)</span>
    <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># year=2006</span>
<span class="c1"># year_range = range(year, year+4)</span>
<span class="c1"># dset = dict()</span>
<span class="c1"># for model in list_models:</span>
<span class="c1">#         if model == &#39;CNRM-CM6-1&#39;:</span>
<span class="c1">#                 dset[model] = search_data(cmip_in, t_res,model,experiment_id,variable_id, year_range, variant_label=&#39;r1i1p1f2&#39;)</span>
<span class="c1">#         else:</span>
<span class="c1">#                 dset[model] = search_data(cmip_in, t_res,model,experiment_id,variable_id, year_range, )</span>
                
<span class="c1"># dset[model].time.sel(time=dset[model].time.dt.month==2)#.attrs[&#39;references&#39;]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in list_models:</span>
<span class="c1">#     print(model, dset[model][&#39;clw&#39;].sel(lat=slice(45,90)).max().values, dset[model][&#39;cli&#39;].sel(lat=slice(45,90)).max().values)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assign-attributes-to-the-variables">
<h2>Assign attributes to the variables<a class="headerlink" href="#assign-attributes-to-the-variables" title="Permalink to this heading">#</a></h2>
<p>We will assign the attributes to the variables as in ERA5 to make CMIP6 and ERA5 variables comperable.</p>
<ul class="simple">
<li><p><a class="reference external" href="http://clipc-services.ceda.ac.uk/dreq/u/62f26742cf240c1b5169a5cd511196b6.html"><code class="docutils literal notranslate"><span class="pre">pr</span></code></a> and <a class="reference external" href="http://clipc-services.ceda.ac.uk/dreq/u/051919eddec810e292c883205c944ceb.html"><code class="docutils literal notranslate"><span class="pre">prsn</span></code></a> in <strong>kg m-2 s-1</strong> <span class="math notranslate nohighlight">\(\rightarrow\)</span> Multiply by <strong>3600</strong> to get <strong>mm h-1</strong> <span class="math notranslate nohighlight">\(\rightarrow\)</span> Multiply by <strong>24</strong> to get <strong>mm day-1</strong></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_att</span><span class="p">(</span><span class="n">dset</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="c1"># </span>
    <span class="k">for</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;prsn&#39;</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;snowfall_flux&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;At surface; includes precipitation of all forms of water in the solid phase&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg m-2 h-1&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg m-2 s-1&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Converted units from &#39;kg m-2 s-1&#39; to &#39;kg m-2 h-1&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)),</span>
                                                            <span class="s1">&#39;cell_methods&#39;</span><span class="p">:</span> <span class="s1">&#39;area: time: mean&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;cell_measures&#39;</span><span class="p">:</span> <span class="s1">&#39;area: areacella&#39;</span><span class="p">})</span>
                
            <span class="k">if</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;pr&#39;</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;precipitation_flux&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;includes both liquid and solid phases&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg m-2 h-1&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg m-2 s-1&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;history&#39;</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Converted units from &#39;kg m-2 s-1&#39; to &#39;kg m-2 h-1&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)),</span>
                                                          <span class="s1">&#39;cell_methods&#39;</span><span class="p">:</span> <span class="s1">&#39;area: time: mean&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;cell_measures&#39;</span><span class="p">:</span> <span class="s1">&#39;area: areacella&#39;</span><span class="p">})</span>
                
                
    <span class="k">return</span> <span class="n">dset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in list_models:</span>
<span class="c1">#     dset[model] = assign_att(dset[model])</span>
<span class="c1"># dset[model].time.sel(time=dset[model].time.dt.month==2)#.attrs[&#39;references&#39;]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels">
<h2>Interpolate from CMIP6 hybrid sigma-pressure levels to isobaric pressure levels<a class="headerlink" href="#interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels" title="Permalink to this heading">#</a></h2>
<p>The vertical variables in the CMIP6 models are in hybrid sigma-pressure levels. Hence the vertical variable in the xarray datasets in <code class="docutils literal notranslate"><span class="pre">dset_dict</span></code> will be calculated by using the formula:
$<span class="math notranslate nohighlight">\( P(i,j,k) = hyam(k) p0 + hybm(k) ps(i,j)\)</span>$
to calculate the pressure</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp_hybrid_plev</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    
    <span class="c1"># You can simplify the if conditions by using the &quot;in&quot; operator to check if the required keys are present in the dictionary.</span>
    <span class="c1"># Rename datasets with different naming convention for constant hyam</span>
    <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">dset</span> <span class="ow">and</span> <span class="s1">&#39;a_bnds&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="s1">&#39;ap&#39;</span><span class="p">,</span> <span class="s1">&#39;a_bnds&#39;</span><span class="p">:</span> <span class="s1">&#39;ap_bnds&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">&#39;nbnd&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;nbnd&#39;</span><span class="p">:</span><span class="s1">&#39;bnds&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">&#39;presnivs&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;presnivs&#39;</span><span class="p">:</span><span class="s1">&#39;plev&#39;</span><span class="p">})</span>
 
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span> <span class="ow">and</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;lev&#39;</span><span class="p">:</span><span class="s1">&#39;plev&#39;</span><span class="p">})</span>

        
    
    
    <span class="c1"># if all the necessary variables are present in the dataset before performing any calculations. If any of the </span>
    <span class="c1"># variables are missing, the function can simply move on to the next variable. This will reduce the number of </span>
    <span class="c1"># unnecessary calculations that are performed.</span>
    <span class="k">for</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">,</span> <span class="s1">&#39;cli&#39;</span><span class="p">]:</span>
        
        <span class="c1"># Convert the model level to isobaric levels</span>
        <span class="c1"># Instead of checking if a key is present in the list of keys returned by dset.keys(), it would be faster </span>
        <span class="c1"># to use the in operator to check if the key is present in the dictionary. For example, instead of </span>
        <span class="c1"># if (&#39;a&#39; in list(dset.keys())) == True:, it would be faster to use if &#39;a&#39; in dset:.</span>
        <span class="k">if</span> <span class="s1">&#39;ap&#39;</span> <span class="ow">in</span> <span class="n">dset</span> <span class="ow">and</span> <span class="s1">&#39;ps&#39;</span> <span class="ow">in</span> <span class="n">dset</span> <span class="ow">and</span> <span class="s1">&#39;p0&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="c1"># Convert to pressure levels</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                <span class="c1"># dset[&#39;plev&#39;] = dset[&#39;plev&#39;].transpose(&#39;time&#39;, &#39;lat&#39;,&#39;lon&#39;, &#39;lev&#39;, ...)</span>
                
            <span class="c1"># Create plev_bnds array</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
            <span class="c1"># Instead of using the transpose method on the entire array, you can specify the dimensions you want to transpose</span>
            <span class="c1"># dset[&#39;plev_bnds&#39;] = dset[&#39;plev_bnds&#39;].transpose(&#39;time&#39;, &#39;lat&#39;,&#39;lon&#39;, &#39;lev&#39;,&#39;bnds&#39;, ...)</span>
                
        <span class="k">elif</span> <span class="s1">&#39;ap&#39;</span> <span class="ow">in</span> <span class="n">dset</span> <span class="ow">and</span> <span class="s1">&#39;ps&#39;</span> <span class="ow">in</span> <span class="n">dset</span> <span class="ow">and</span> <span class="s1">&#39;p0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                <span class="c1"># dset[&#39;plev&#39;] = dset[&#39;plev&#39;].transpose(&#39;time&#39;, &#39;lat&#39;,&#39;lon&#39;, &#39;lev&#39;, ...)</span>
            
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;CNRM-CM6-1&#39;</span> <span class="ow">or</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;CNRM-ESM2-1&#39;</span><span class="p">:</span>   
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">)</span>
                <span class="n">_abnds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
                <span class="n">ap_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lev</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">ap_bnds</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">ap_bnds</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_abnds</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ap_bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_abnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ap_bnds</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_abnds</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ap_bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_abnds</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;bnds&#39;</span><span class="p">)</span>
                <span class="n">_bbnds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
                <span class="n">b_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lev</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">b_bnds</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">b_bnds</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bbnds</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">b_bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bbnds</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">b_bnds</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bbnds</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">b_bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bbnds</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="n">b_bnds</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="n">ap_bnds</span>

                
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
            <span class="c1"># dset[&#39;plev_bnds&#39;] = dset[&#39;plev_bnds&#39;].transpose(&#39;time&#39;, &#39;lat&#39;,&#39;lon&#39;, &#39;lev&#39;,&#39;bnds&#39;, ...)</span>

        
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;plev&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">,</span><span class="o">...</span><span class="p">,</span> <span class="n">missing_dims</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span> <span class="p">)</span>

        <span class="c1"># Remove unnecessary variables</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;ap&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;ap_bnds&#39;</span><span class="p">,</span> <span class="s1">&#39;b_bnds&#39;</span><span class="p">,</span> <span class="s1">&#39;lev_bnds&#39;</span><span class="p">,</span> <span class="s1">&#39;orog&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        
        
                
                
    <span class="k">return</span> <span class="n">dset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in list_models:</span>
<span class="c1">#     dset[model] = interp_hybrid_plev(dset[model], model)</span>

<span class="c1"># model = &#39;CNRM-ESM2-1&#39;</span>
<span class="c1"># dset[model].time.sel(time=dset[model].time.dt.month==2)#.attrs[&#39;references&#39;]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-liquid-water-path-from-content">
<h2>Calculate liquid water path from content<a class="headerlink" href="#calculate-liquid-water-path-from-content" title="Permalink to this heading">#</a></h2>
<p>Once the pressure levels are calculated the daily average LWP (IWP) is calculated for each CMIP6 model.
\begin{equation}
LWP = \rho_{air} \cdot \Delta clw \cdot \Delta Z
\end{equation}</p>
<p>with hydrostatic equation</p>
<p>\begin{equation}
\frac{\Delta p}{\Delta Z}  = -\rho_{air} \cdot g<br />
\end{equation}</p>
<p>\begin{equation}
\leftrightarrow LWP = - \frac{\rho_{air}}{\rho_{air} g} \cdot \Delta clw \Delta p
\end{equation}</p>
<p>with <span class="math notranslate nohighlight">\(\Delta clw = clw(NLEV-k)\)</span> and <span class="math notranslate nohighlight">\(\Delta p = p(NLEV-k + 1/2) - p(NLEV-k - 1/2)\)</span> follows for the total liquid water path in the column:</p>
<p>\begin{equation}
-\frac{1}{g} \sum_{k=0}^{NLEV+1} LWP(k) = -\frac{1}{g} \sum_{k=0}^{NLEV+1} clw(NLEV-k) \cdot [p(NLEV-k + 1/2) - p(NLEV-k - 1/2)]
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_water_path</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mf">9.81</span><span class="p">,</span> <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()):</span>
    
    
    <span class="k">if</span> <span class="s1">&#39;plev&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;bnds&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM6A-LR&#39;</span> <span class="ow">or</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">klevp1</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;klevp1&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;klevp1&#39;</span><span class="p">:</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plev</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;klevp1&#39;</span><span class="p">:</span><span class="s1">&#39;lev&#39;</span><span class="p">})</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;plev&#39;</span><span class="p">:</span><span class="s1">&#39;lev&#39;</span><span class="p">})</span>
    <span class="k">elif</span> <span class="s1">&#39;phalf&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;phalf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;half_lev&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;half_lev&#39;</span><span class="p">:</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lev</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;half_lev&#39;</span><span class="p">:</span><span class="s1">&#39;lev&#39;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dset</span>
    
    <span class="n">_lwp</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dp</span> <span class="o">/</span> <span class="n">g</span> <span class="o">*</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span>
    <span class="n">lwp_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_lwp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">_lwp</span><span class="o">.</span><span class="n">get_axis_num</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">lwp_sum</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;prsn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;prsn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    
    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span>
            <span class="s1">&#39;long_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Daily average Liquid Water Path&#39;</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_liquid_water&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Liquid Water Path&#39;</span><span class="p">,</span>
            <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/kg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate lwp with hydrostatic equation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="p">})</span>
        
    <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;clw&#39;</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="s1">&#39;cli&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
        <span class="n">_iwp</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dp</span> <span class="o">/</span> <span class="n">g</span> <span class="o">*</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span>
        <span class="n">iwp_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_iwp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">_iwp</span><span class="o">.</span><span class="n">get_axis_num</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">iwp_sum</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;prsn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;prsn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        
        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span>
                <span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Ice Water Path&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_ice_water&#39;</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Ice Water Path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi2&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/kg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate clivi2 with hydrostatic equation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
            
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;cli&#39;</span><span class="p">])</span>
    
    <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">,</span><span class="o">...</span> <span class="p">)</span>    
    <span class="k">return</span> <span class="n">dset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in list_models:</span>
<span class="c1">#     dset[model] = calc_water_path(dset[model],model, g=9.81, now = datetime.utcnow())</span>
    
<span class="c1"># # model = &#39;CNRM-ESM2-1&#39;</span>
<span class="c1"># dset[model]#.time.sel(time=dset[model].time.dt.month==2)#.attrs[&#39;references&#39;]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model = &#39;CNRM-CM6-1&#39;</span>
<span class="c1"># cm6 = cnrm[model][&#39;lwp&#39;].groupby(&#39;time.month&#39;).mean(&#39;time&#39;, skipna=True)</span>
<span class="c1"># lwp_cm6 = dset[model][&#39;lwp&#39;].groupby(&#39;time.month&#39;).mean(&#39;time&#39;, skipna=True)</span>
<span class="c1"># lwp_cm6 = lwp_cm6.astype(np.float32)</span>

<span class="c1"># model = &#39;CNRM-ESM2-1&#39;</span>
<span class="c1"># esm2 = cnrm[model][&#39;lwp&#39;].groupby(&#39;time.month&#39;).mean(&#39;time&#39;, skipna=True)</span>
<span class="c1"># lwp_esm2 = dset[model][&#39;lwp&#39;].groupby(&#39;time.month&#39;).mean(&#39;time&#39;, skipna=True)</span>
<span class="c1"># lwp_esm2 = lwp_esm2.astype(np.float32)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="regrid-cmip6-data-to-ipsl-cm6a-lr-and-ipsl-cm5a2-inca-grid-a-id-regrid-hz-a">
<h2>Regrid CMIP6 data to IPSL-CM6A-LR and IPSL-CM5A2-INCA grid <a id='regrid_hz'></a><a class="headerlink" href="#regrid-cmip6-data-to-ipsl-cm6a-lr-and-ipsl-cm5a2-inca-grid-a-id-regrid-hz-a" title="Permalink to this heading">#</a></h2>
<p>We want to conduct statistical analysis at the annual and seasonal timescales to determine the biases in cloud phase and precipitation (liquid and solid) in the CMIP6 models. At the moment we have all historical data from the CMIP6 models. For this, we will have to extract the 4-year period between 2006 and 2009.</p>
<p><span class="math notranslate nohighlight">\(\rightarrow\)</span> Define a start and end year.</p>
<p>The CMIP6 high resolution models have approximately a nominal resolution of 250km. But not all have identical grid spacing. Hence we will make use of the python package <code class="docutils literal notranslate"><span class="pre">xesmf</span></code> and the documentation on <a class="reference external" href="https://xesmf.readthedocs.io/en/latest/notebooks/Compare_algorithms.html#Decreasing-resolution">decreasing resolution</a>, <a class="reference external" href="https://xesmf.readthedocs.io/en/latest/notebooks/Masking.html?highlight=conservative#Limitations-and-warnings">Limitations and warnings</a>.</p>
<p>IPSL-CM6A-LR will be the reference grid for models with 250km resolution.</p>
<p><span class="math notranslate nohighlight">\(\rightarrow\)</span> Define IPSL-CM6A-LR as the reference grid <code class="docutils literal notranslate"><span class="pre">ds_out</span></code>.</p>
<p>Create a new Python dictionary (<code class="docutils literal notranslate"><span class="pre">dset_gridded</span></code>) with the regridded CMIP6 <code class="docutils literal notranslate"><span class="pre">xarray</span></code> datasets between 2006 an 2009. Save each regridded model to a <code class="docutils literal notranslate"><span class="pre">netcdf</span></code>, locally.</p>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> This step may take several minutes!</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">regrid_and_save</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">ds_out</span><span class="p">,</span> <span class="n">grid_model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cmip_in</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>

    <span class="k">if</span> <span class="s1">&#39;lat_bnds&#39;</span> <span class="ow">in</span> <span class="n">dset</span> <span class="ow">or</span> <span class="s1">&#39;lon_bnds&#39;</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">({</span><span class="s1">&#39;lat_bnds&#39;</span><span class="p">,</span> <span class="s1">&#39;lon_bnds&#39;</span><span class="p">})</span>
    
    <span class="n">regridder</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">Regridder</span><span class="p">(</span><span class="n">ds_in</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">ds_out</span><span class="o">=</span><span class="n">ds_out</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;conservative&quot;</span><span class="p">)</span>
    <span class="n">dset_regrid</span> <span class="o">=</span> <span class="n">regridder</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;areacella&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset_regrid</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">dset_regrid</span><span class="p">[</span><span class="s1">&#39;areacella&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="s1">&#39;areacella&#39;</span><span class="p">]</span>

    <span class="c1"># var_ids = [&#39;clivi&#39;, &#39;lwp&#39;, &#39;pr&#39;, &#39;prsn&#39;, &#39;tas&#39;, &#39;areacella&#39;]</span>
    <span class="n">var_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="n">var_ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset_regrid</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing regrid files: var_id: </span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1">, year: </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">, model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">variant_label</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">]</span>
            <span class="n">NH_file_grid</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmip_in</span><span class="si">}</span><span class="s1">/common_grid/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grid_model</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_40_90_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variant_label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">0101-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">1231.nc&#39;</span>
            <span class="n">SH_file_grid</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmip_in</span><span class="si">}</span><span class="s1">/common_grid/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">grid_model</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_-40_-90_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variant_label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">0101-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">1231.nc&#39;</span>
            <span class="p">(</span><span class="n">dset_regrid</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">90</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">NH_file_grid</span><span class="p">)</span>
            <span class="p">(</span><span class="n">dset_regrid</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">SH_file_grid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1"> does not exist in </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># return dset_regrid</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in list_models:</span>
<span class="c1">#     for grid_model in [&#39;IPSL-CM6A-LR&#39;, &#39;IPSL-CM5A2-INCA&#39;]:</span>
<span class="c1">#                 ds_out = xr.open_dataset(glob(f&quot;{cmip_in}/single_model/{grid_model}/areacella_*{grid_model}_{experiment_id[0]}*.nc&quot;)[0],)</span>
<span class="c1">#                 # Shift longitude to be from -180 to 180</span>
<span class="c1">#                 ds_out = ds_out.assign_coords(lon=(((ds_out[&#39;lon&#39;] + 180) % 360) - 180)).sortby(&#39;lon&#39;)</span>
<span class="c1">#                 if grid_model == &#39;IPSL-CM6A-LR&#39;:</span>
<span class="c1">#                         if model == &#39;CanESM5&#39; or model == &#39;IPSL-CM5A2-INCA&#39;:</span>
<span class="c1">#                                 continue</span>
<span class="c1">#                         else:</span>
<span class="c1">#                                 dset_regrid = regrid_and_save(dset[model], ds_out, grid_model, model, cmip_in, year)</span>
<span class="c1">#                 elif grid_model == &#39;IPSL-CM5A2-INCA&#39;:</span>
<span class="c1">#                         dset_regrid = regrid_and_save(dset[model], ds_out, grid_model, model, cmip_in, year)    </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Create a memory object with a cache directory</span>
<span class="c1"># cache_dir = &#39;/scratch/franzihe/cache_dir/&#39;</span>
<span class="c1"># memory = Memory(location=cache_dir)</span>

<span class="c1"># # Decorate the search_data function with the cache memory</span>
<span class="c1"># @memory.cache</span>
<span class="c1"># def search_data_cached(t_res, model, experiment_id, variable_id, year_range):</span>
<span class="c1">#     return search_data(t_res, model, experiment_id, variable_id, year_range)</span>

<span class="k">def</span> <span class="nf">process_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span><span class="n">variable_id</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">list_models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;CNRM-CM6-1&#39;</span><span class="p">:</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="n">search_data</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">experiment_id</span><span class="p">,</span><span class="n">variable_id</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">variant_label</span><span class="o">=</span><span class="s1">&#39;r1i1p1f2&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="n">search_data</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">experiment_id</span><span class="p">,</span><span class="n">variable_id</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">)</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">assign_att</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">interp_hybrid_plev</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span><span class="n">model</span><span class="p">)</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">calc_water_path</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mf">9.81</span><span class="p">,</span> <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        
       
        <span class="c1"># for var_id in [&#39;clivi&#39;, &#39;lwp&#39;, &#39;pr&#39;, &#39;prsn&#39;, &#39;tas&#39;, &#39;areacella&#39;]:</span>
        <span class="k">for</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">,]:</span>
            <span class="k">if</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing files: var_id: </span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1">, year: </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">, model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">variant_label</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">]</span>
                <span class="n">NH_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmip_in</span><span class="si">}</span><span class="s1">/single_model/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_40_90_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variant_label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">0101-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">1231.nc&#39;</span>
                <span class="n">SH_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmip_in</span><span class="si">}</span><span class="s1">/single_model/</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_-40_-90_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variant_label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">0101-</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">1231.nc&#39;</span>
                
                <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">90</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">NH_file</span><span class="p">)</span>
                <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">40</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">SH_file</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_id</span><span class="si">}</span><span class="s1"> does not exist in </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">grid_model</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IPSL-CM6A-LR&#39;</span><span class="p">,</span> <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span><span class="p">]:</span>
                <span class="n">ds_out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmip_in</span><span class="si">}</span><span class="s2">/single_model/</span><span class="si">{</span><span class="n">grid_model</span><span class="si">}</span><span class="s2">/areacella_*</span><span class="si">{</span><span class="n">grid_model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">*.nc&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],)</span>
                <span class="c1"># Shift longitude to be from -180 to 180</span>
                <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">(((</span><span class="n">ds_out</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">grid_model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM6A-LR&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;CanESM5&#39;</span> <span class="ow">or</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                                <span class="n">regrid_and_save</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">ds_out</span><span class="p">,</span> <span class="n">grid_model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cmip_in</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">grid_model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span><span class="p">:</span>
                        <span class="n">regrid_and_save</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">ds_out</span><span class="p">,</span> <span class="n">grid_model</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cmip_in</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>  
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2006</span><span class="p">,]:</span>
             <span class="c1">#2007,2008, 2009]:</span>
    <span class="c1"># This will run the process_year function for each year in parallel, using all available cores (n_jobs=-1).</span>
    <span class="c1"># Parallel(n_jobs=-1)(delayed(process_year)(year, list_models, t_res, experiment_id,variable_id))# for year in [2006, 2007, 2008, 2009])</span>
    <span class="n">process_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span><span class="n">variable_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for year in [2006, 2007, 2008, 2009]:</span>
<span class="c1">#     cnrm = dict()</span>
<span class="c1">#     for model in [&#39;CNRM-CM6-1&#39;, &#39;CNRM-ESM2-1&#39;]:</span>
<span class="c1">#         # print(model)</span>
<span class="c1">#         file = glob(f&#39;/scratch/franzihe/input/cmip6_hist/single_model/{model}_Amon/lwp_AERmon_{model}_historical_*_gr_185001-201412.nc&#39;)</span>
<span class="c1">#         cnrm[model] = xr.open_mfdataset(file)</span>
<span class="c1">#         cnrm[model] = cnrm[model].sel(time=cnrm[model][&#39;time&#39;].dt.year.isin(range(year, year+1))).squeeze()</span>
<span class="c1">#         cnrm[model] = cnrm[model].assign_coords(lon=(((cnrm[model][&#39;lon&#39;] + 180) % 360) - 180)).sortby(&#39;lon&#39;).sortby(&#39;time&#39;)</span>

<span class="c1">#         for grid_model in [&#39;IPSL-CM6A-LR&#39;, &#39;IPSL-CM5A2-INCA&#39;]:</span>
<span class="c1">#             ds_out = xr.open_dataset(glob(f&quot;{cmip_in}/single_model/{grid_model}/areacella_*{grid_model}_{experiment_id[0]}*.nc&quot;)[0],)</span>
<span class="c1">#             # Shift longitude to be from -180 to 180</span>
<span class="c1">#             ds_out = ds_out.assign_coords(lon=(((ds_out[&#39;lon&#39;] + 180) % 360) - 180)).sortby(&#39;lon&#39;)</span>
<span class="c1">#             if grid_model == &#39;IPSL-CM6A-LR&#39;:</span>
<span class="c1">#                 if model == &#39;CanESM5&#39; or model == &#39;IPSL-CM5A2-INCA&#39;:</span>
<span class="c1">#                     continue</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     regrid_and_save(cnrm[model], ds_out, grid_model, model, cmip_in, year)</span>
<span class="c1">#             elif grid_model == &#39;IPSL-CM5A2-INCA&#39;:</span>
<span class="c1">#                 regrid_and_save(cnrm[model], ds_out, grid_model, model, cmip_in, year)   </span>
</pre></div>
</div>
</div>
</div>
<img src="https://drive.google.com/uc?id=1zb0LHvipx8JOXLLrCxzYToJM7eNK4eaw"  height="100" />
<img src="https://reliance.rohub.org/static/media/Reliance-logo.433dc2e9.png"  height="100" />
<img src="https://www.uio.no/vrtx/decorating/resources/dist/src2/images/footer/uio-logo-en.svg"  height="100" />
<img src="https://erc.europa.eu/sites/default/files/logo_0.png"  height="100" />
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./cmip"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Example with CMIP6 models (100 - 500 km)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-introduction-a">1. Introduction <a id="introduction"></a></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#data-wrangling-a-id-data-wrangling-a">2. Data Wrangling <a id="data_wrangling"></a></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organize-my-data">Organize my data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-python-packages">Import python packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#open-cmip6-variables">Open CMIP6 variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#search-corresponding-data">Search corresponding data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-attributes-to-the-variables">Assign attributes to the variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels">Interpolate from CMIP6 hybrid sigma-pressure levels to isobaric pressure levels</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-liquid-water-path-from-content">Calculate liquid water path from content</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#regrid-cmip6-data-to-ipsl-cm6a-lr-and-ipsl-cm5a2-inca-grid-a-id-regrid-hz-a">Regrid CMIP6 data to IPSL-CM6A-LR and IPSL-CM5A2-INCA grid <a id="regrid_hz"></a></a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Franziska Hellmuth
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>