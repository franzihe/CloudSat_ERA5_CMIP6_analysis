

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Example with CMIP6 models (100 - 500 km) &#8212; globalsnow</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cmip/CMIP6_daily_2006-2009';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to Global Snow project website
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ERA5/ERA5_1985-2014.html">Example with ERA5 high-resolution (~0.25deg) monthly means</a></li>






<li class="toctree-l1"><a class="reference internal" href="../CMIP6_ERA5_CloudSat/plt_seasonal_mean.html">Analysis of CMIP6, ERA5, and CloudSat</a></li>








<li class="toctree-l1"><a class="reference internal" href="CMIP6_hr_1985-2014.html">Example with CMIP6 models (100 - 500 km)</a></li>








<li class="toctree-l1 has-children"><a class="reference internal" href="../cloudsat.html">Cloudsat</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../CloudSat/get_pressure_grid.html">Example to get CloudSat mean pressure level profile</a></li>



<li class="toctree-l2"><a class="reference internal" href="../CloudSat/read_2C_snow.html">Regrid CloudSat data to horizontal grid</a></li>



</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/franzihe/CloudSat_ERA5_CMIP6_analysis" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/franzihe/CloudSat_ERA5_CMIP6_analysis/issues/new?title=Issue%20on%20page%20%2Fcmip/CMIP6_daily_2006-2009.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/cmip/CMIP6_daily_2006-2009.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example with CMIP6 models (100 - 500 km)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Example with CMIP6 models (100 - 500 km)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-introduction-a">1. Introduction <a id="introduction"></a></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#data-wrangling-a-id-data-wrangling-a">2. Data Wrangling <a id="data_wrangling"></a></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organize-my-data">Organize my data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-python-packages">Import python packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#open-cmip6-variables">Open CMIP6 variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#search-corresponding-data">Search corresponding data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-attributes-to-the-variables">Assign attributes to the variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels">Interpolate from CMIP6 hybrid sigma-pressure levels to isobaric pressure levels</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-liquid-water-path-from-content">Calculate liquid water path from content</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># export PYTHONPATH=&quot;${PYTHONPATH}:/uio/kant/geo-metos-u1/franzihe/Documents/Python/globalsnow/CloudSat_ERA5_CMIP6_analysis/utils/&quot;</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="example-with-cmip6-models-100-500-km">
<h1>Example with CMIP6 models (100 - 500 km)<a class="headerlink" href="#example-with-cmip6-models-100-500-km" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="table-of-contents">
<h1>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">#</a></h1>
<ul>
<li><a href="#introduction">1. Introduction</a></li>
<li><a href="#data_wrangling">2. Data Wrangling</a></li>
<li><a href="#exploratory">3. Exploratory Data Analysis</a></li>
<li><a href="#conclusion">4. Conclusion</a></li>
<li><a href="#references">5. References</a></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction-a-id-introduction-a">
<h1>1. Introduction <a id='introduction'></a><a class="headerlink" href="#introduction-a-id-introduction-a" title="Permalink to this heading">#</a></h1>
<p>Cloud feedbacks are a major contributor to the spread of climate sensitivity in global climate models (GCMs) <a class="reference external" href="https://doi-org.ezproxy.uio.no/10.1029/2019GL085782">Zelinka et al. (2020)</a>. Among the most poorly understood cloud feedbacks is the one associated with the cloud phase, which is expected to be modified with climate change <a class="reference external" href="https://doi-org.ezproxy.uio.no/10.1038/s41561-020-00649-1">Bjordal et al. (2020)</a>. Cloud phase bias, in addition, has significant implications for the simulation of radiative properties and glacier and ice sheet mass balances in climate models.</p>
<p>In this context, this work aims to expand our knowledge on how the representation of the cloud phase affects snow formation in GCMs. Better understanding this aspect is necessary to develop climate models further and improve future climate predictions.</p>
<ul class="simple">
<li><p>Retrieve CMIP6 data through <a class="reference external" href="https://esgf-node.llnl.gov/search/cmip6/">ESGF</a></p></li>
<li><p>Hybrid sigma-pressure coordinates to isobaric pressure levels of the European Centre for Medium-Range Weather Forecast Re-Analysis 5 (ERA5) with <a class="reference external" href="https://geocat-comp.readthedocs.io/en/latest/index.html">GeoCAT-comb</a></p></li>
<li><p>Regridd the CMIP6 variables to the exact horizontal resolution with <a class="reference external" href="https://xesmf.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">xesmf</span></code></a></p></li>
<li><p>Calculate an ensemble mean of all used models</p></li>
<li><p>Calculate and plot the seasonal mean of the ensemble mean</p></li>
</ul>
<p><strong>Questions</strong></p>
<ul class="simple">
<li><p>How is the cloud phase and snowfall varying between 2007 and 2010?</p></li>
</ul>
<blockquote>
<div><p><strong><em>NOTE:</em></strong> We answer questions related to the comparison of CMIP models to ERA5 in another <a class="reference internal" href="../CMIP6_ERA5_CloudSat/plt_seasonal_mean.html"><span class="doc std std-doc">Jupyter Notebook</span></a>.</p>
</div></blockquote>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="data-wrangling-a-id-data-wrangling-a">
<h1>2. Data Wrangling <a id='data_wrangling'></a><a class="headerlink" href="#data-wrangling-a-id-data-wrangling-a" title="Permalink to this heading">#</a></h1>
<p>This study will compare surface snowfall, ice, and liquid water content from the Coupled Model Intercomparison Project Phase 6 (<a class="reference external" href="https://esgf-node.llnl.gov/projects/cmip6/">CMIP6</a>) climate models to the European Centre for Medium-Range Weather Forecast Re-Analysis 5 (<a class="reference external" href="https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5">ERA5</a>) data from <strong>2006 to 2009</strong>. We conduct statistical analysis at the annual and seasonal timescales to determine the biases in cloud phase and precipitation (liquid and solid) in the CMIP6 models and their potential connection between them.</p>
<ul class="simple">
<li><p>Time period: 2006 to 2009</p></li>
<li><p>horizonal resolution: depending on model</p></li>
<li><p>time resolution: daily mean atmospheric data (CFday, day)</p></li>
<li><p>Variables:</p></li>
</ul>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>shortname</p></th>
<th class="head text-center"><p>Long name</p></th>
<th class="head text-right"><p>Units</p></th>
<th class="head text-right"><p>levels</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>prsn</p></td>
<td class="text-center"><p>Snowfall Flux</p></td>
<td class="text-right"><p>[kg m-2 s-1]</p></td>
<td class="text-right"><p>surface</p></td>
</tr>
<tr class="row-odd"><td><p>clw</p></td>
<td class="text-center"><p>Mass Fraction of Cloud Liquid Water</p></td>
<td class="text-right"><p>[kg kg-1]</p></td>
<td class="text-right"><p>ml</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td class="text-center"><p></p></td>
<td class="text-right"><p>to calculate lwp use integral clw -dp/dg</p></td>
<td class="text-right"><p></p></td>
</tr>
<tr class="row-odd"><td><p>tas</p></td>
<td class="text-center"><p>Near-Surface Air Temperature</p></td>
<td class="text-right"><p>[K]</p></td>
<td class="text-right"><p>surface</p></td>
</tr>
<tr class="row-even"><td><p>clivi</p></td>
<td class="text-center"><p>Ice Water Path</p></td>
<td class="text-right"><p>[kg m-2]</p></td>
<td class="text-right"><p></p></td>
</tr>
<tr class="row-odd"><td><p>lwp</p></td>
<td class="text-center"><p>Liquid Water Path</p></td>
<td class="text-right"><p>[kg m-2]</p></td>
<td class="text-right"><p></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>CMIP6 models:</p></li>
</ul>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Institution</p></th>
<th class="head text-center"><p>Model name</p></th>
<th class="head text-right"><p>Reference</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="xref myst">MIROC</span></p></td>
<td class="text-center"><p>MIROC6</p></td>
<td class="text-right"><p><span class="xref myst">Tatebe et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">NCAR</span></p></td>
<td class="text-center"><p>CESM2</p></td>
<td class="text-right"><p><span class="xref myst">Danabasoglu et al. (2020)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">CCCma</span></p></td>
<td class="text-center"><p>CanESM5</p></td>
<td class="text-right"><p><span class="xref myst">Swart et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">AWI</span></p></td>
<td class="text-center"><p>AWI-ESM-1-1-LR</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">MOHC</span></p></td>
<td class="text-center"><p>UKESM1-0-LL</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">MOHC</span></p></td>
<td class="text-center"><p>HadGem3-GC31-LL</p></td>
<td class="text-right"><p><span class="xref myst">Roberts et al. (2019)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">CNRM-CERFACS</span></p></td>
<td class="text-center"><p>CNRM-CM6-1</p></td>
<td class="text-right"><p><span class="xref myst">Voldoire et al. (2019)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">CNRM-CERFACS</span></p></td>
<td class="text-center"><p>CNRM-ESM2-1</p></td>
<td class="text-right"><p><span class="xref myst">Seferian et al. (2019)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="xref myst">IPSL</span></p></td>
<td class="text-center"><p>IPSL-CM6A-LR</p></td>
<td class="text-right"><p><span class="xref myst">Boucher et al. (2020)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="xref myst">IPSL</span></p></td>
<td class="text-center"><p>IPSL-CM5A2-INCA</p></td>
<td class="text-right"><p><span class="xref myst"></span></p></td>
</tr>
</tbody>
</table>
<section id="organize-my-data">
<h2>Organize my data<a class="headerlink" href="#organize-my-data" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Define a prefix for my project (you may need to adjust it for your own usage on your infrastructure).</p>
<ul>
<li><p>input folder where all the data used as input to my Jupyter Notebook is stored (and eventually shared)</p></li>
<li><p>output folder where all the results to keep are stored</p></li>
<li><p>tool folder where all the tools</p></li>
</ul>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">/input/cmip6_hist/daily_means</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

<span class="n">abs_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
<span class="n">WORKDIR</span> <span class="o">=</span> <span class="n">abs_path</span><span class="p">[:</span><span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abs_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>


<span class="k">if</span> <span class="s2">&quot;mimi&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/scratch/franzihe/&quot;</span>
    <span class="n">FIG_DIR</span> <span class="o">=</span> <span class="s2">&quot;/uio/kant/geo-metos-u1/franzihe/Documents/Figures/CMIP6/&quot;</span>
<span class="k">elif</span> <span class="s2">&quot;glefsekaldt&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span> 
    <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/home/franzihe/Data/&quot;</span>
    <span class="n">FIG_DIR</span> <span class="o">=</span> <span class="s2">&quot;/home/franzihe/Documents/Figures/CMIP6/&quot;</span>

<span class="n">INPUT_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
<span class="n">OUTPUT_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
<span class="n">UTILS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">WORKDIR</span><span class="p">,</span> <span class="s1">&#39;utils/&#39;</span><span class="p">)</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UTILS_DIR</span><span class="p">)</span>
<span class="c1"># make figure directory</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mimi.uio.no
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-python-packages">
<h2>Import python packages<a class="headerlink" href="#import-python-packages" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Python</span></code> environment requirements: file <a class="reference download internal" download="" href="../_downloads/06f3f4f78bf14ffb9f9cfdf395203c3c/requirements_globalsnow.txt"><span class="xref download myst">requirements_globalsnow.txt</span></a></p></li>
<li><p>load <code class="docutils literal notranslate"><span class="pre">python</span></code> packages from <a class="reference download internal" download="" href="../_downloads/5eb7796ec8541cded4dcee2282ad687a/imports.py"><span class="xref download myst">imports.py</span></a></p></li>
<li><p>load <code class="docutils literal notranslate"><span class="pre">functions</span></code> from <a class="reference download internal" download="" href="../_downloads/3afa0d66b1ce4f3999c315ad3a2e691d/functions.py"><span class="xref download myst">functions.py</span></a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># supress warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1"># don&#39;t output warnings</span>

<span class="c1"># import packages</span>
<span class="kn">from</span> <span class="nn">imports</span> <span class="kn">import</span> <span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="n">intake</span><span class="p">,</span> <span class="n">cftime</span><span class="p">,</span> <span class="n">xe</span><span class="p">,</span> <span class="n">glob</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">pd</span><span class="p">,</span> <span class="n">fct</span><span class="p">,</span><span class="n">ccrs</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">LogNorm</span><span class="p">)</span>
<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">display_style</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.core.options.set_options at 0x7feedac60640&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reload imports</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
</div>
</section>
<section id="open-cmip6-variables">
<h2>Open CMIP6 variables<a class="headerlink" href="#open-cmip6-variables" title="Permalink to this heading">#</a></h2>
<p>Get the data required for the analysis. Beforehand we downloaded the daily averaged data on single levels and model levels via.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmip_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT_DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;cmip6_hist/daily_means/single_model&#39;</span><span class="p">)</span>
<span class="n">cmip_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DATA_DIR</span><span class="p">,</span> <span class="s1">&#39;cmip6_hist/daily_means/common_grid&#39;</span><span class="p">)</span>

<span class="c1"># make output data directory</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cmip_out</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variable_id</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">,</span> <span class="s1">&#39;cli&#39;</span><span class="p">,</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;prsn&#39;</span><span class="p">,</span> <span class="s1">&#39;pr&#39;</span><span class="p">,</span> <span class="s1">&#39;areacella&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>At the moment we have downloaded the end of the historical simulations for CMIP6 models. We define start and end year to ensure to only extract the 4-year period between 2006 and 2009.</p>
<p><span class="math notranslate nohighlight">\(\rightarrow\)</span> Define a start and end year</p>
<p>We will load all available models into one dictonary, which includes an xarray dataset with <code class="docutils literal notranslate"><span class="pre">xarray.open_mfdataset(file)</span></code> and select the time range <a class="reference external" href="https://xarray.pydata.org/en/stable/user-guide/indexing.html">by name</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># source_id</span>
<span class="n">list_models</span> <span class="o">=</span> <span class="p">[</span>
               <span class="s1">&#39;MIROC6&#39;</span><span class="p">,</span> <span class="c1">#area</span>
               <span class="s1">&#39;CESM2&#39;</span><span class="p">,</span> <span class="c1">#area</span>
               <span class="s1">&#39;CanESM5&#39;</span><span class="p">,</span> <span class="c1"># area</span>
               <span class="s1">&#39;AWI-ESM-1-1-LR&#39;</span><span class="p">,</span> <span class="c1"># area</span>
               <span class="s1">&#39;MPI-ESM1-2-LR&#39;</span><span class="p">,</span> <span class="c1"># area</span>
               <span class="c1"># &#39;UKESM1-0-LL&#39;, </span>
               <span class="c1"># &#39;HadGEM3-GC31-LL&#39;,</span>
               <span class="s1">&#39;CNRM-CM6-1&#39;</span><span class="p">,</span> <span class="c1">#area</span>
               <span class="s1">&#39;CNRM-ESM2-1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;IPSL-CM6A-LR&#39;</span><span class="p">,</span> <span class="c1">#area</span>
               <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span> <span class="c1">#area</span>
            <span class="p">]</span>

<span class="c1">## experiment</span>
<span class="n">experiment_id</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;historical&#39;</span><span class="p">]</span>

<span class="c1">## time resolution</span>
<span class="n">t_res</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">,]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">starty</span> <span class="o">=</span> <span class="mi">2006</span><span class="p">;</span> <span class="n">endy</span> <span class="o">=</span> <span class="mi">2009</span>
<span class="n">year_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">starty</span><span class="p">,</span> <span class="n">endy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="search-corresponding-data">
<h2>Search corresponding data<a class="headerlink" href="#search-corresponding-data" title="Permalink to this heading">#</a></h2>
<p>Get the data required for the analysis. Define variables, models, experiment, and time resolution as defined in <a href="#data_wrangling">2. Data Wrangling</a>
.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">search_data</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">):</span>
    <span class="n">dset_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">list_models</span><span class="p">:</span>
        <span class="c1"># print(model)</span>
        <span class="n">cmip_file_in</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/*</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># get also areacella data</span>
        <span class="c1"># print(model)</span>
        <span class="n">cmip_file_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/areacella*</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">*.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span><span class="n">model</span><span class="p">,</span>  <span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmip_file_in</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cmip_file_in</span><span class="p">),</span> <span class="n">combine</span><span class="o">=</span><span class="s1">&#39;nested&#39;</span><span class="p">,</span> <span class="n">compat</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="n">use_cftime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># select only years needed for analysis</span>
            <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">year_range</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="c1"># shift longitude to be from -180 to 180</span>
            <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="p">(((</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span><span class="p">)</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
    
    <span class="k">return</span> <span class="n">dset_dict</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># variant_label = [&#39;r10i1p1f1&#39;,</span>
<span class="c1"># &#39;r11i1p1f1&#39;,</span>
<span class="c1"># &#39;r1i1p1f1&#39;,</span>
<span class="c1"># &#39;r1i1p1f2&#39;,</span>
<span class="c1"># &#39;r1i1p2f1&#39;,</span>
<span class="c1"># &#39;r2i1p1f2&#39;,</span>
<span class="c1"># &#39;r5i1p1f3&#39;,]</span>

<span class="c1"># model = &#39;IPSL-CM6A-LR&#39;</span>
<span class="c1"># model = list_models[5]</span>
<span class="c1"># # for model in list_models:</span>
<span class="c1"># cmip_file_in = sorted(glob(&#39;{}/*{}_{}_{}*&#39;.format(cmip_in, t_res[0], model, experiment_id[0])))</span>
<span class="c1"># cmip_file_in.append(glob(&#39;{}/areacella*{}_{}*.nc&#39;.format(cmip_in,model,  experiment_id[0]))[0])</span>
<span class="c1"># _cmip_file_in = []#dict()</span>
<span class="c1"># for i in range(len(cmip_file_in)):</span>
<span class="c1">#             # k = variant_label[0]</span>
<span class="c1">#         for k in variant_label:</span>
<span class="c1">#             if cmip_file_in[i].find(str(k)) != -1:</span>
<span class="c1">#                 print(&quot;Contains &quot;+str(k), cmip_file_in[i][59:63])</span>
<span class="c1">#                 _cmip_file_in.append(cmip_file_in[i])</span>
<span class="c1">#             # else:</span>
<span class="c1">#             # # cmip_file_in.remove(cmip_file_in[i])</span>
<span class="c1">#             #     print(cmip_file_in[i])</span>
<span class="c1"># print(model, len(_cmip_file_in))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dset_dict = search_data(cmip_in, t_res, list_models, year_range)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MIROC6
CESM2
CanESM5
AWI-ESM-1-1-LR
MPI-ESM1-2-LR
CNRM-CM6-1
CNRM-ESM2-1
IPSL-CM6A-LR
IPSL-CM5A2-INCA
</pre></div>
</div>
</div>
</div>
</section>
<section id="assign-attributes-to-the-variables">
<h2>Assign attributes to the variables<a class="headerlink" href="#assign-attributes-to-the-variables" title="Permalink to this heading">#</a></h2>
<p>We will assign the attributes to the variables as in ERA5 to make CMIP6 and ERA5 variables comperable.</p>
<ul class="simple">
<li><p><a class="reference external" href="http://clipc-services.ceda.ac.uk/dreq/u/62f26742cf240c1b5169a5cd511196b6.html"><code class="docutils literal notranslate"><span class="pre">pr</span></code></a> and <a class="reference external" href="http://clipc-services.ceda.ac.uk/dreq/u/051919eddec810e292c883205c944ceb.html"><code class="docutils literal notranslate"><span class="pre">prsn</span></code></a> in <strong>kg m-2 s-1</strong> <span class="math notranslate nohighlight">\(\rightarrow\)</span> Multiply by <strong>3600</strong> to get <strong>mm h-1</strong> <span class="math notranslate nohighlight">\(\rightarrow\)</span> Multiply by <strong>24</strong> to get <strong>mm day-1</strong></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_att</span><span class="p">(</span><span class="n">dset</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="c1"># </span>
    <span class="k">for</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;prsn&#39;</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Total snowfall per day&#39;</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;At surface; includes precipitation of all forms of water in the solid phase&#39;</span><span class="p">,</span>
        <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;mm day-1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg m-2 s-1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Converted units from &#39;kg m-2 s-1&#39; to &#39;kg m-2 day-1&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)),</span>
        <span class="s1">&#39;cell_methods&#39;</span><span class="p">:</span> <span class="s1">&#39;area: time: mean&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cell_measures&#39;</span><span class="p">:</span> <span class="s1">&#39;area: areacella&#39;</span><span class="p">})</span>
                
                
    <span class="k">return</span> <span class="n">dset</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels">
<h2>Interpolate from CMIP6 hybrid sigma-pressure levels to isobaric pressure levels<a class="headerlink" href="#interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels" title="Permalink to this heading">#</a></h2>
<p>The vertical variables in the CMIP6 models are in hybrid sigma-pressure levels. Hence the vertical variable in the xarray datasets in <code class="docutils literal notranslate"><span class="pre">dset_dict</span></code> will be calculated by using the formula:
$<span class="math notranslate nohighlight">\( P(i,j,k) = hyam(k) p0 + hybm(k) ps(i,j)\)</span>$
to calculate the pressure</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">interp_hybrid_plev</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="c1"># Rename datasets with different naming convention for constant hyam</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="s1">&#39;ap&#39;</span><span class="p">,</span> <span class="s1">&#39;a_bnds&#39;</span><span class="p">:</span> <span class="s1">&#39;ap_bnds&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;nbnd&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;nbnd&#39;</span><span class="p">:</span><span class="s1">&#39;bnds&#39;</span><span class="p">,</span> <span class="p">})</span>

    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM6A-LR&#39;</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;presnivs&#39;</span><span class="p">:</span><span class="s1">&#39;plev&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;IPSL-CM5A2-INCA&#39;</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;lev&#39;</span><span class="p">:</span><span class="s1">&#39;plev&#39;</span><span class="p">})</span>  
        
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;klevp1&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;klevp1&#39;</span><span class="p">:</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="p">})</span>
        
    <span class="k">for</span> <span class="n">var_id</span> <span class="ow">in</span> <span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span><span class="c1">#[&#39;clw&#39;, &#39;cli&#39;]:</span>
        <span class="k">if</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;clw&#39;</span> <span class="ow">or</span> <span class="n">var_id</span> <span class="o">==</span> <span class="s1">&#39;cli&#39;</span><span class="p">:</span>
            <span class="c1"># Convert the model level to isobaric levels</span>
            <span class="c1">#### ap, b, ps, p0</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ap&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;ps&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;p0&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var_id</span><span class="p">,</span> <span class="s1">&#39;lev, ap, ps, p0&#39;</span><span class="p">)</span>
                        <span class="c1"># dset[var_id] = gc.interpolation.interp_hybrid_to_pressure(data = dset[var_id],</span>
                        <span class="c1">#                                                                                 ps   = dset[&#39;ps&#39;], </span>
                        <span class="c1">#                                                                                 hyam = dset[&#39;ap&#39;], </span>
                        <span class="c1">#                                                                                 hybm = dset[&#39;b&#39;], </span>
                        <span class="c1">#                                                                                 p0   = dset[&#39;p0&#39;], </span>
                        <span class="c1">#                                                                                 new_levels=new_levels,</span>
                        <span class="c1">#                                                                                 lev_dim=&#39;lev&#39;)</span>
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>
                        
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;plev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var_id</span><span class="p">,</span> <span class="s1">&#39;variable on pressure levels&#39;</span><span class="p">,</span> <span class="p">)</span>
                    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">)</span>
                <span class="c1"># if (&#39;lev&#39; in list(dset[var_id].coords)) == True and \</span>
                <span class="c1">#     (&#39;lev&#39; in list(dset[&#39;ap&#39;].coords)) == False and \</span>
                <span class="c1">#     (&#39;lev&#39; in list(dset[&#39;b&#39;].coords)) == False:</span>
                <span class="c1">#         print(model, &#39;variable on pressure levels&#39;, &#39;lev, ap, ps,&#39;)</span>
            <span class="c1"># Convert the model level to isobaric levels</span>
            <span class="c1">#### ap, b, p0</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ap&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;ps&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;p0&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">var_id</span><span class="p">,</span> <span class="s1">&#39;lev, ap, ps,&#39;</span><span class="p">)</span>
                        <span class="c1"># dset[var_id] = gc.interpolation.interp_hybrid_to_pressure(data = dset[var_id],</span>
                        <span class="c1">#                                                                                 ps   = dset[&#39;ps&#39;], </span>
                        <span class="c1">#                                                                                 hyam = dset[&#39;ap&#39;], </span>
                        <span class="c1">#                                                                                 hybm = dset[&#39;b&#39;], </span>
                        <span class="c1">#                                                                                 new_levels=new_levels,</span>
                        <span class="c1">#                                                                                 lev_dim=&#39;lev&#39;)</span>
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">)</span>
                        
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">)</span>
                        
                        
                
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;plev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">var_id</span><span class="p">,</span> <span class="s1">&#39;variable on pressure levels&#39;</span><span class="p">,</span> <span class="p">)</span>
                    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ap_bnds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;b_bnds&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>
                    <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;orog&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="n">var_id</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="s1">&#39;lev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;pfull&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;hybrid height coordinate&#39;</span><span class="p">)</span>
                        
    <span class="n">dset</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;plev&#39;</span><span class="p">,</span> <span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="s1">&#39;bnds&#39;</span><span class="p">,</span><span class="s1">&#39;axis_nbounds&#39;</span> <span class="p">,</span> <span class="n">missing_dims</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span> <span class="p">)</span>
    
                
        
    <span class="k">return</span> <span class="n">dset</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in dset_dict.keys():</span>
<span class="c1">#     dset_dict[model] = interp_hybrid_plev(dset_dict[model],model)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MIROC6 cli lev, ap, ps, p0
MIROC6 clw lev, ap, ps, p0
CESM2 clw lev, ap, ps, p0
CanESM5 cli lev, ap, ps,
CanESM5 clw lev, ap, ps,
AWI-ESM-1-1-LR clw lev, ap, ps,
MPI-ESM1-2-LR clw lev, ap, ps,
CNRM-CM6-1 clw lev, ap, ps,
CNRM-ESM2-1 clw lev, ap, ps,
IPSL-CM6A-LR clw variable on pressure levels
IPSL-CM5A2-INCA clw variable on pressure levels
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-liquid-water-path-from-content">
<h2>Calculate liquid water path from content<a class="headerlink" href="#calculate-liquid-water-path-from-content" title="Permalink to this heading">#</a></h2>
<p>Once the pressure levels are calculated the daily average LWP (IWP) is calculated for each CMIP6 model.
\begin{equation}
LWP = \rho_{air} \cdot \Delta clw \cdot \Delta Z
\end{equation}</p>
<p>with hydrostatic equation</p>
<p>\begin{equation}
\frac{\Delta p}{\Delta Z}  = -\rho_{air} \cdot g<br />
\end{equation}</p>
<p>\begin{equation}
\leftrightarrow LWP = - \frac{\rho_{air}}{\rho_{air} g} \cdot \Delta clw \Delta p
\end{equation}</p>
<p>with <span class="math notranslate nohighlight">\(\Delta clw = clw(NLEV-k)\)</span> and <span class="math notranslate nohighlight">\(\Delta p = p(NLEV-k + 1/2) - p(NLEV-k - 1/2)\)</span> follows for the total liquid water path in the column:</p>
<p>\begin{equation}
-\frac{1}{g} \sum_{k=0}^{NLEV+1} LWP(k) = -\frac{1}{g} \sum_{k=0}^{NLEV+1} clw(NLEV-k) \cdot [p(NLEV-k + 1/2) - p(NLEV-k - 1/2)]
\end{equation}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_water_path</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;plev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;plev&#39;</span><span class="p">)</span>
        <span class="n">_lwp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                <span class="n">dims</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                <span class="n">coords</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="c1"># lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lev&#39;</span><span class="p">])):</span>
                        
            <span class="c1"># calculate pressure difference between two levels, where the hight of the two layers is given in lev_bnds</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;bnds&#39;</span><span class="p">))</span>
            <span class="c1"># use liquid water content between two layers, meaning at lev</span>
            <span class="n">dlwc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
            <span class="c1"># calculate liquid water path between two layers</span>
            <span class="n">_lwp</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">9.81</span> <span class="o">*</span> <span class="n">dlwc</span><span class="p">[:,:,:]</span>
                
            <span class="c1"># sum over all layers to ge the liquid water path in the atmospheric column</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_lwp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            
            <span class="c1"># assign attributes to data array</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Liquid Water Path&#39;</span><span class="p">,</span> 
                                                                            <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_liquid_water&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Liquid Water Path&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,</span> <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/kg&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate lwp with hydrostatic equation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
        <span class="c1"># when ice water path does not exist</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clivi&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># if (&#39;clivi&#39; in list(dset.keys())) == True:</span>
            <span class="n">_iwp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                    <span class="n">dims</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                    <span class="n">coords</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="c1"># lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lev&#39;</span><span class="p">])):</span>
                                
                <span class="c1"># calculate pressure difference between two levels, where the hight of the two layers is given in lev_bnds</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;bnds&#39;</span><span class="p">))</span>
                <span class="c1"># use liquid water content between two layers, meaning at lev</span>
                <span class="n">diwc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
                <span class="c1"># calculate liquid water path between two layers</span>
                <span class="n">_lwp</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">9.81</span> <span class="o">*</span> <span class="n">dlwc</span><span class="p">[:,:,:]</span>
                    
                <span class="c1"># sum over all layers to ge the liquid water path in the atmospheric column</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_iwp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="c1"># assign attributes to data array</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Ice Water Path&#39;</span><span class="p">,</span> 
                                                                                <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_ice_water&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Ice Water Path&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/kg&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate clivi with hydrostatic equation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clivi&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Ice Water Path&#39;</span><span class="p">,</span> 
                                                                                <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_ice_water&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Ice Water Path&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/m2&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Rename attributes to daily average ice water path&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
            
            
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;plev&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;plev coord&#39;</span><span class="p">)</span>
        <span class="n">_lwp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                <span class="n">dims</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                <span class="n">coords</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="c1"># lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">])):</span>
                        
            <span class="c1"># calculate pressure difference between two levels, where the hight of the two layers is given in lev_bnds</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;bnds&#39;</span><span class="p">))</span>
            <span class="c1"># use liquid water content between two layers, meaning at lev</span>
            <span class="n">dlwc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">plev</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
            <span class="c1"># calculate liquid water path between two layers</span>
            <span class="n">_lwp</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">9.81</span> <span class="o">*</span> <span class="n">dlwc</span><span class="p">[:,:,:]</span>
                
            <span class="c1"># sum over all layers to ge the liquid water path in the atmospheric column</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_lwp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;plev&#39;</span><span class="p">,</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># assign attributes to data array</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;lwp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Liquid Water Path&#39;</span><span class="p">,</span> 
                                                                            <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_liquid_water&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Liquid Water Path&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,</span> <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/kg&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate lwp with hydrostatic equation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
        <span class="c1"># when ice water path does not exist</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clivi&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># if (&#39;clivi&#39; in list(dset.keys())) == True:</span>
            <span class="n">_iwp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                    <span class="n">dims</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                    <span class="n">coords</span><span class="o">=</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="c1"># lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev&#39;</span><span class="p">])):</span>
                                
                <span class="c1"># calculate pressure difference between two levels, where the hight of the two layers is given in lev_bnds</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;plev_bnds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;bnds&#39;</span><span class="p">))</span>
                <span class="c1"># use liquid water content between two layers, meaning at lev</span>
                <span class="n">diwc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;cli&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
                <span class="c1"># calculate liquid water path between two layers</span>
                <span class="n">_lwp</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dp</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">9.81</span> <span class="o">*</span> <span class="n">dlwc</span><span class="p">[:,:,:]</span>
                    
                <span class="c1"># sum over all layers to ge the liquid water path in the atmospheric column</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_iwp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="c1"># assign attributes to data array</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Ice Water Path&#39;</span><span class="p">,</span> 
                                                                                <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_ice_water&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Ice Water Path&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/kg&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate clivi with hydrostatic equation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
            
        
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;clivi&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;clivi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">({</span><span class="s1">&#39;long_name&#39;</span><span class="p">:</span><span class="s1">&#39;Daily average Ice Water Path&#39;</span><span class="p">,</span> 
                                                                                <span class="s1">&#39;units&#39;</span> <span class="p">:</span> <span class="s1">&#39;kg m-2&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;mipTable&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;out_name&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;atmosphere_mass_content_of_cloud_ice_water&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Ice Water Path&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;variable_id&#39;</span><span class="p">:</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;original_units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/m2&#39;</span><span class="p">,</span>
                                                                                    <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">Z altered by F. Hellmuth: Rename attributes to daily average ice water path&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">))})</span>
               
    <span class="k">return</span> <span class="n">dset</span>

    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in dset_dict.keys():</span>
<span class="c1">#     dset_dict[model] = calc_water_path(dset_dict[model], model)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MIROC6 plev
CESM2 plev
CanESM5 plev
AWI-ESM-1-1-LR plev
MPI-ESM1-2-LR plev
CNRM-CM6-1 plev
CNRM-ESM2-1 plev
IPSL-CM6A-LR plev coord
IPSL-CM5A2-INCA plev coord
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">):</span>
    
    <span class="n">dset_dict</span> <span class="o">=</span> <span class="n">search_data</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">dset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># dset_dict[model] = assign_att(dset_dict[model])</span>
        <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_hybrid_plev</span><span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">],</span><span class="n">model</span><span class="p">)</span>
        <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_water_path</span><span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">model</span><span class="p">)</span>
        
        <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][[</span><span class="s1">&#39;prsn&#39;</span><span class="p">,</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,]]</span>
    
    <span class="k">return</span> <span class="n">dset_dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dset_dict</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HDF5-DIAG: Error detected in HDF5 (1.12.2) thread 1:
  #000: H5F.c line 620 in H5Fopen(): unable to open file
    major: File accessibility
    minor: Unable to open file
  #001: H5VLcallback.c line 3501 in H5VL_file_open(): failed to iterate over available VOL connector plugins
    major: Virtual Object Layer
    minor: Iteration failed
  #002: H5PLpath.c line 578 in H5PL__path_table_iterate(): can&#39;t iterate over plugins in plugin path &#39;(null)&#39;
    major: Plugin for dynamically loaded library
    minor: Iteration failed
  #003: H5PLpath.c line 620 in H5PL__path_table_iterate_process_path(): can&#39;t open directory: /uio/kant/geo-metos-u1/franzihe/miniconda3/envs/globalsnow/lib/hdf5/plugin
    major: Plugin for dynamically loaded library
    minor: Can&#39;t open directory or file
  #004: H5VLcallback.c line 3351 in H5VL__file_open(): open failed
    major: Virtual Object Layer
    minor: Can&#39;t open object
  #005: H5VLnative_file.c line 97 in H5VL__native_file_open(): unable to open file
    major: File accessibility
    minor: Unable to open file
  #006: H5Fint.c line 1990 in H5F_open(): unable to read superblock
    major: File accessibility
    minor: Read failed
  #007: H5Fsuper.c line 614 in H5F__super_read(): truncated file: eof = 512909312, sblock-&gt;base_addr = 0, stored_eof = 1783574260
    major: File accessibility
    minor: File has been truncated
HDF5-DIAG: Error detected in HDF5 (1.12.2) thread 2:
  #000: H5F.c line 620 in H5Fopen(): unable to open file
    major: File accessibility
    minor: Unable to open file
  #001: H5VLcallback.c line 3501 in H5VL_file_open(): failed to iterate over available VOL connector plugins
    major: Virtual Object Layer
    minor: Iteration failed
  #002: H5PLpath.c line 578 in H5PL__path_table_iterate(): can&#39;t iterate over plugins in plugin path &#39;(null)&#39;
    major: Plugin for dynamically loaded library
    minor: Iteration failed
  #003: H5PLpath.c line 620 in H5PL__path_table_iterate_process_path(): can&#39;t open directory: /uio/kant/geo-metos-u1/franzihe/miniconda3/envs/globalsnow/lib/hdf5/plugin
    major: Plugin for dynamically loaded library
    minor: Can&#39;t open directory or file
  #004: H5VLcallback.c line 3351 in H5VL__file_open(): open failed
    major: Virtual Object Layer
    minor: Can&#39;t open object
  #005: H5VLnative_file.c line 97 in H5VL__native_file_open(): unable to open file
    major: File accessibility
    minor: Unable to open file
  #006: H5Fint.c line 1990 in H5F_open(): unable to read superblock
    major: File accessibility
    minor: Read failed
  #007: H5Fsuper.c line 614 in H5F__super_read(): truncated file: eof = 1080492032, sblock-&gt;base_addr = 0, stored_eof = 1782936602
    major: File accessibility
    minor: File has been truncated
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/file_manager.py:201,</span> in <span class="ni">CachingFileManager._acquire_with_cache_info</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">201</span>     <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/lru_cache.py:55,</span> in <span class="ni">LRUCache.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">55</span>     <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="ne">KeyError</span>: [&lt;class &#39;netCDF4._netCDF4.Dataset&#39;&gt;, (&#39;/scratch/franzihe/input/cmip6_hist/daily_means/pr_day_CanESM5_historical_r1i1p1f1_gn_18500101-20141231.nckv226ylq.tmp&#39;,), &#39;r&#39;, ((&#39;clobber&#39;, True), (&#39;diskless&#39;, False), (&#39;format&#39;, &#39;NETCDF4&#39;), (&#39;persist&#39;, False))]

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">OSError</span><span class="g g-Whitespace">                                   </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">dset_dict</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">)</span>

<span class="nn">Cell In [13], line 3,</span> in <span class="ni">process</span><span class="nt">(cmip_in, t_res, list_models, year_range)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="n">dset_dict</span> <span class="o">=</span> <span class="n">search_data</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">,</span> <span class="n">list_models</span><span class="p">,</span> <span class="n">year_range</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">dset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>         <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_att</span><span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">])</span>

<span class="nn">Cell In [9], line 7,</span> in <span class="ni">search_data</span><span class="nt">(cmip_in, t_res, list_models, year_range)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">cmip_file_in</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/*</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span> <span class="n">t_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmip_file_in</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">7</span>     <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cmip_file_in</span><span class="p">),</span> <span class="n">combine</span><span class="o">=</span><span class="s1">&#39;nested&#39;</span><span class="p">,</span> <span class="n">compat</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">,</span> <span class="n">use_cftime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="c1"># select only years needed for analysis</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">year_range</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/api.py:996,</span> in <span class="ni">open_mfdataset</span><span class="nt">(paths, chunks, concat_dim, compat, preprocess, engine, data_vars, coords, combine, parallel, join, attrs_file, combine_attrs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">991</span>     <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">993</span> <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">994</span>     <span class="c1"># calling compute here will return the datasets/file_objs lists,</span>
<span class="g g-Whitespace">    </span><span class="mi">995</span>     <span class="c1"># the underlying datasets will still be stored as dask arrays</span>
<span class="ne">--&gt; </span><span class="mi">996</span>     <span class="n">datasets</span><span class="p">,</span> <span class="n">closers</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">closers</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">998</span> <span class="c1"># Combine all datasets, closing them in case of a ValueError</span>
<span class="g g-Whitespace">    </span><span class="mi">999</span> <span class="k">try</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/base.py:600,</span> in <span class="ni">compute</span><span class="nt">(traverse, optimize_graph, scheduler, get, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">597</span>     <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">__dask_keys__</span><span class="p">())</span>
<span class="g g-Whitespace">    </span><span class="mi">598</span>     <span class="n">postcomputes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">__dask_postcompute__</span><span class="p">())</span>
<span class="ne">--&gt; </span><span class="mi">600</span> <span class="n">results</span> <span class="o">=</span> <span class="n">schedule</span><span class="p">(</span><span class="n">dsk</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="nn">    601 return repack([f(r, *a) for r, (f, a)</span> in <span class="ni">zip</span><span class="nt">(results, postcomputes)])</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/threaded.py:89,</span> in <span class="ni">get</span><span class="nt">(dsk, keys, cache, num_workers, pool, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span>     <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span>         <span class="n">pool</span> <span class="o">=</span> <span class="n">MultiprocessingPoolExecutor</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">89</span> <span class="n">results</span> <span class="o">=</span> <span class="n">get_async</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span>     <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">91</span>     <span class="n">pool</span><span class="o">.</span><span class="n">_max_workers</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">92</span>     <span class="n">dsk</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span>     <span class="n">keys</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>     <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>     <span class="n">get_id</span><span class="o">=</span><span class="n">_thread_get_id</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span>     <span class="n">pack_exception</span><span class="o">=</span><span class="n">pack_exception</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span> <span class="c1"># Cleanup pools associated to dead threads</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="k">with</span> <span class="n">pools_lock</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/local.py:511,</span> in <span class="ni">get_async</span><span class="nt">(submit, num_workers, dsk, result, cache, get_id, rerun_exceptions_locally, pack_exception, raise_exception, callbacks, dumps, loads, chunksize, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">509</span>         <span class="n">_execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>  <span class="c1"># Re-execute locally</span>
<span class="g g-Whitespace">    </span><span class="mi">510</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">511</span>         <span class="n">raise_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">512</span> <span class="n">res</span><span class="p">,</span> <span class="n">worker_id</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">res_info</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">513</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;cache&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/local.py:319,</span> in <span class="ni">reraise</span><span class="nt">(exc, tb)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span> <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">tb</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span>     <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">319</span> <span class="k">raise</span> <span class="n">exc</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/local.py:224,</span> in <span class="ni">execute_task</span><span class="nt">(key, task_info, dumps, loads, get_id, pack_exception)</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span>     <span class="n">task</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">task_info</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">224</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">_execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span>     <span class="nb">id</span> <span class="o">=</span> <span class="n">get_id</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">226</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">_execute_task</span><span class="nt">(arg, cache, dsk)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/utils.py:71,</span> in <span class="ni">apply</span><span class="nt">(func, args, kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Apply a function given its positional and keyword arguments.</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">42</span><span class="sd"> Equivalent to ``func(*args, **kwargs)``</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span><span class="sd"> &gt;&gt;&gt; dsk = {&#39;task-name&#39;: task}  # adds the task to a low level Dask task graph</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span> <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">71</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">72</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/api.py:531,</span> in <span class="ni">open_dataset</span><span class="nt">(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, inline_array, backend_kwargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">519</span> <span class="n">decoders</span> <span class="o">=</span> <span class="n">_resolve_decoders_kwargs</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">520</span>     <span class="n">decode_cf</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">521</span>     <span class="n">open_backend_dataset_parameters</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">open_dataset_parameters</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">527</span>     <span class="n">decode_coords</span><span class="o">=</span><span class="n">decode_coords</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span> <span class="n">overwrite_encoded_chunks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;overwrite_encoded_chunks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">531</span> <span class="n">backend_ds</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">533</span>     <span class="n">drop_variables</span><span class="o">=</span><span class="n">drop_variables</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span>     <span class="o">**</span><span class="n">decoders</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">537</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">_dataset_from_backend_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">538</span>     <span class="n">backend_ds</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">539</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">547</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">548</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">549</span> <span class="k">return</span> <span class="n">ds</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:555,</span> in <span class="ni">NetCDF4BackendEntrypoint.open_dataset</span><span class="nt">(self, filename_or_obj, mask_and_scale, decode_times, concat_characters, decode_coords, drop_variables, use_cftime, decode_timedelta, group, mode, format, clobber, diskless, persist, lock, autoclose)</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span> <span class="k">def</span> <span class="nf">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>     <span class="bp">self</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">551</span>     <span class="n">autoclose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">552</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">554</span>     <span class="n">filename_or_obj</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">555</span>     <span class="n">store</span> <span class="o">=</span> <span class="n">NetCDF4DataStore</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">556</span>         <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">557</span>         <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">558</span>         <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">559</span>         <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">560</span>         <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">561</span>         <span class="n">diskless</span><span class="o">=</span><span class="n">diskless</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">562</span>         <span class="n">persist</span><span class="o">=</span><span class="n">persist</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">563</span>         <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">564</span>         <span class="n">autoclose</span><span class="o">=</span><span class="n">autoclose</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">565</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">567</span>     <span class="n">store_entrypoint</span> <span class="o">=</span> <span class="n">StoreBackendEntrypoint</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">568</span>     <span class="k">with</span> <span class="n">close_on_error</span><span class="p">(</span><span class="n">store</span><span class="p">):</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:384,</span> in <span class="ni">NetCDF4DataStore.open</span><span class="nt">(cls, filename, mode, format, group, clobber, diskless, persist, lock, lock_maker, autoclose)</span>
<span class="g g-Whitespace">    </span><span class="mi">378</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span>     <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">diskless</span><span class="o">=</span><span class="n">diskless</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="n">persist</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">CachingFileManager</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>     <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">383</span> <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">384</span> <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span> <span class="n">autoclose</span><span class="o">=</span><span class="n">autoclose</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:332,</span> in <span class="ni">NetCDF4DataStore.__init__</span><span class="nt">(self, manager, group, mode, lock, autoclose)</span>
<span class="g g-Whitespace">    </span><span class="mi">330</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">group</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
<span class="ne">--&gt; </span><span class="mi">332</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data_model</span>
<span class="g g-Whitespace">    </span><span class="mi">333</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_remote</span> <span class="o">=</span> <span class="n">is_remote_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:393,</span> in <span class="ni">NetCDF4DataStore.ds</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">391</span> <span class="nd">@property</span>
<span class="g g-Whitespace">    </span><span class="mi">392</span> <span class="k">def</span> <span class="nf">ds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">393</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquire</span><span class="p">()</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:387,</span> in <span class="ni">NetCDF4DataStore._acquire</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span> <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needs_lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">387</span>     <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">acquire_context</span><span class="p">(</span><span class="n">needs_lock</span><span class="p">)</span> <span class="k">as</span> <span class="n">root</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">388</span>         <span class="n">ds</span> <span class="o">=</span> <span class="n">_nc4_require_group</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>     <span class="k">return</span> <span class="n">ds</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/contextlib.py:135,</span> in <span class="ni">_GeneratorContextManager.__enter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">135</span>     <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">137</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;generator didn&#39;t yield&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/file_manager.py:189,</span> in <span class="ni">CachingFileManager.acquire_context</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span> <span class="k">def</span> <span class="nf">acquire_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needs_lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Context manager for acquiring a file.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">189</span>     <span class="n">file</span><span class="p">,</span> <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquire_with_cache_info</span><span class="p">(</span><span class="n">needs_lock</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>     <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>         <span class="k">yield</span> <span class="n">file</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/file_manager.py:207,</span> in <span class="ni">CachingFileManager._acquire_with_cache_info</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span>     <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
<span class="ne">--&gt; </span><span class="mi">207</span> <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opener</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="c1"># ensure file doesn&#39;t get overridden when opened again</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

<span class="nn">File src/netCDF4/_netCDF4.pyx:2463,</span> in <span class="ni">netCDF4._netCDF4.Dataset.__init__</span><span class="nt">()</span>

<span class="nn">File src/netCDF4/_netCDF4.pyx:2026,</span> in <span class="ni">netCDF4._netCDF4._ensure_nc_success</span><span class="nt">()</span>

<span class="ne">OSError</span>: [Errno -101] NetCDF: HDF error: b&#39;/scratch/franzihe/input/cmip6_hist/daily_means/pr_day_CanESM5_historical_r1i1p1f1_gn_18500101-20141231.nckv226ylq.tmp&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">dset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;prsn&#39;</span><span class="p">,</span> <span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;clivi&#39;</span><span class="p">,</span> <span class="s1">&#39;lwp&#39;</span><span class="p">,]:</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">year_range</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing files: var: </span><span class="si">{}</span><span class="s1">, year: </span><span class="si">{}</span><span class="s1">, model: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>
            <span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span><span class="mi">90</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_45_90_historical_</span><span class="si">{}</span><span class="s1">_gn_</span><span class="si">{}</span><span class="s1">0101-</span><span class="si">{}</span><span class="s1">1231.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span><span class="n">var</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">],</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>
            <span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">45</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_-90_-45_historical_</span><span class="si">{}</span><span class="s1">_gn_</span><span class="si">{}</span><span class="s1">0101-</span><span class="si">{}</span><span class="s1">1231.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span><span class="n">var</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">],</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>
            
            <span class="c1"># (dset_dict[model][var].sel(time=slice(str(year)), lat=slice(-90,-45))).to_netcdf(&#39;{}/{}_{}_-90_-45_historical_{}_gn_{}0101-{}1231.nc&#39;.format(cmip_in,var, model, dset_dict[model].attrs[&#39;variant_label&#39;],year, year))</span>
            <span class="c1"># (dset_dict[model][var].sel(time=slice(str(year)), lat=slice(45,90))).to_netcdf(&#39;{}/{}_{}_45_90_historical_{}_gn_{}0101-{}1231.nc&#39;.format(cmip_in,var, model, dset_dict[model].attrs[&#39;variant_label&#39;],year, year))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing files: var: prsn, year: 2006, model: IPSL-CM6A-LR
Writing files: var: prsn, year: 2007, model: IPSL-CM6A-LR
Writing files: var: prsn, year: 2008, model: IPSL-CM6A-LR
Writing files: var: prsn, year: 2009, model: IPSL-CM6A-LR
Writing files: var: tas, year: 2006, model: IPSL-CM6A-LR
Writing files: var: tas, year: 2007, model: IPSL-CM6A-LR
Writing files: var: tas, year: 2008, model: IPSL-CM6A-LR
Writing files: var: tas, year: 2009, model: IPSL-CM6A-LR
Writing files: var: clivi, year: 2006, model: IPSL-CM6A-LR
Writing files: var: clivi, year: 2007, model: IPSL-CM6A-LR
Writing files: var: clivi, year: 2008, model: IPSL-CM6A-LR
Writing files: var: clivi, year: 2009, model: IPSL-CM6A-LR
Writing files: var: lwp, year: 2006, model: IPSL-CM6A-LR
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">MemoryError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">year_range</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing files: var: </span><span class="si">{}</span><span class="s1">, year: </span><span class="si">{}</span><span class="s1">, model: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">5</span>     <span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span><span class="mi">90</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_45_90_historical_</span><span class="si">{}</span><span class="s1">_gn_</span><span class="si">{}</span><span class="s1">0101-</span><span class="si">{}</span><span class="s1">1231.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span><span class="n">var</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">],</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="p">(</span><span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">45</span><span class="p">)))</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_-90_-45_historical_</span><span class="si">{}</span><span class="s1">_gn_</span><span class="si">{}</span><span class="s1">0101-</span><span class="si">{}</span><span class="s1">1231.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmip_in</span><span class="p">,</span><span class="n">var</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dset_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;variant_label&#39;</span><span class="p">],</span><span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/core/dataarray.py:3739,</span> in <span class="ni">DataArray.to_netcdf</span><span class="nt">(self, path, mode, format, group, engine, encoding, unlimited_dims, compute, invalid_netcdf)</span>
<span class="g g-Whitespace">   </span><span class="mi">3735</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">3736</span>     <span class="c1"># No problems with the name - so we&#39;re fine!</span>
<span class="g g-Whitespace">   </span><span class="mi">3737</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
<span class="ne">-&gt; </span><span class="mi">3739</span> <span class="k">return</span> <span class="n">to_netcdf</span><span class="p">(</span>  <span class="c1"># type: ignore  # mypy cannot resolve the overloads:(</span>
<span class="g g-Whitespace">   </span><span class="mi">3740</span>     <span class="n">dataset</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3741</span>     <span class="n">path</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3742</span>     <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3743</span>     <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3744</span>     <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3745</span>     <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3746</span>     <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3747</span>     <span class="n">unlimited_dims</span><span class="o">=</span><span class="n">unlimited_dims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3748</span>     <span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3749</span>     <span class="n">multifile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3750</span>     <span class="n">invalid_netcdf</span><span class="o">=</span><span class="n">invalid_netcdf</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3751</span> <span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/api.py:1235,</span> in <span class="ni">to_netcdf</span><span class="nt">(dataset, path_or_file, mode, format, group, engine, encoding, unlimited_dims, compute, multifile, invalid_netcdf)</span>
<span class="g g-Whitespace">   </span><span class="mi">1232</span> <span class="k">if</span> <span class="n">multifile</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1233</span>     <span class="k">return</span> <span class="n">writer</span><span class="p">,</span> <span class="n">store</span>
<span class="ne">-&gt; </span><span class="mi">1235</span> <span class="n">writes</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1237</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">BytesIO</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1238</span>     <span class="n">store</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/xarray/backends/common.py:168,</span> in <span class="ni">ArrayWriter.sync</span><span class="nt">(self, compute)</span>
<span class="g g-Whitespace">    </span><span class="mi">162</span> <span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span> <span class="c1"># TODO: consider wrapping targets with dask.delayed, if this makes</span>
<span class="g g-Whitespace">    </span><span class="mi">165</span> <span class="c1"># for any discernible difference in perforance, e.g.,</span>
<span class="g g-Whitespace">    </span><span class="mi">166</span> <span class="c1"># targets = [dask.delayed(t) for t in self.targets]</span>
<span class="ne">--&gt; </span><span class="mi">168</span> <span class="n">delayed_store</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">169</span>     <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">170</span>     <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">171</span>     <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span>     <span class="n">compute</span><span class="o">=</span><span class="n">compute</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">173</span>     <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">174</span>     <span class="n">regions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">175</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/array/core.py:1237,</span> in <span class="ni">store</span><span class="nt">(***failed resolving arguments***)</span>
<span class="g g-Whitespace">   </span><span class="mi">1235</span> <span class="k">elif</span> <span class="n">compute</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1236</span>     <span class="n">store_dsk</span> <span class="o">=</span> <span class="n">HighLevelGraph</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1237</span>     <span class="n">compute_as_if_collection</span><span class="p">(</span><span class="n">Array</span><span class="p">,</span> <span class="n">store_dsk</span><span class="p">,</span> <span class="n">map_keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1238</span>     <span class="k">return</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1240</span> <span class="k">else</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/base.py:342,</span> in <span class="ni">compute_as_if_collection</span><span class="nt">(cls, dsk, keys, scheduler, get, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">340</span> <span class="n">schedule</span> <span class="o">=</span> <span class="n">get_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="n">get</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span> <span class="n">dsk2</span> <span class="o">=</span> <span class="n">optimization_function</span><span class="p">(</span><span class="bp">cls</span><span class="p">)(</span><span class="n">dsk</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">342</span> <span class="k">return</span> <span class="n">schedule</span><span class="p">(</span><span class="n">dsk2</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/threaded.py:89,</span> in <span class="ni">get</span><span class="nt">(dsk, keys, cache, num_workers, pool, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span>     <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span>         <span class="n">pool</span> <span class="o">=</span> <span class="n">MultiprocessingPoolExecutor</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">89</span> <span class="n">results</span> <span class="o">=</span> <span class="n">get_async</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">90</span>     <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">91</span>     <span class="n">pool</span><span class="o">.</span><span class="n">_max_workers</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">92</span>     <span class="n">dsk</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span>     <span class="n">keys</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span>     <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>     <span class="n">get_id</span><span class="o">=</span><span class="n">_thread_get_id</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span>     <span class="n">pack_exception</span><span class="o">=</span><span class="n">pack_exception</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span> <span class="c1"># Cleanup pools associated to dead threads</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="k">with</span> <span class="n">pools_lock</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/local.py:511,</span> in <span class="ni">get_async</span><span class="nt">(submit, num_workers, dsk, result, cache, get_id, rerun_exceptions_locally, pack_exception, raise_exception, callbacks, dumps, loads, chunksize, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">509</span>         <span class="n">_execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>  <span class="c1"># Re-execute locally</span>
<span class="g g-Whitespace">    </span><span class="mi">510</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">511</span>         <span class="n">raise_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">512</span> <span class="n">res</span><span class="p">,</span> <span class="n">worker_id</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">res_info</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">513</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;cache&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/local.py:319,</span> in <span class="ni">reraise</span><span class="nt">(exc, tb)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span> <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">tb</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span>     <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">319</span> <span class="k">raise</span> <span class="n">exc</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/local.py:224,</span> in <span class="ni">execute_task</span><span class="nt">(key, task_info, dumps, loads, get_id, pack_exception)</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span>     <span class="n">task</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">task_info</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">224</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">_execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span>     <span class="nb">id</span> <span class="o">=</span> <span class="n">get_id</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">226</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">_execute_task</span><span class="nt">(arg, cache, dsk)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">&lt;genexpr&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">_execute_task</span><span class="nt">(arg, cache, dsk)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">&lt;genexpr&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

    <span class="p">[</span><span class="o">...</span> <span class="n">skipping</span> <span class="n">similar</span> <span class="n">frames</span><span class="p">:</span> <span class="n">_execute_task</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">119</span> <span class="p">(</span><span class="mi">3</span> <span class="n">times</span><span class="p">),</span> <span class="o">&lt;</span><span class="n">genexpr</span><span class="o">&gt;</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">119</span> <span class="p">(</span><span class="mi">2</span> <span class="n">times</span><span class="p">)]</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">&lt;genexpr&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">_execute_task</span><span class="nt">(arg, cache, dsk)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/optimization.py:990,</span> in <span class="ni">SubgraphCallable.__call__</span><span class="nt">(self, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">988</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inkeys</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">989</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected </span><span class="si">%d</span><span class="s2"> args, got </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inkeys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
<span class="ne">--&gt; </span><span class="mi">990</span> <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outkey</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inkeys</span><span class="p">,</span> <span class="n">args</span><span class="p">)))</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:149,</span> in <span class="ni">get</span><span class="nt">(dsk, out, cache)</span>
<span class="g g-Whitespace">    </span><span class="mi">147</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">toposort</span><span class="p">(</span><span class="n">dsk</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="n">task</span> <span class="o">=</span> <span class="n">dsk</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">149</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">_execute_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">150</span>     <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_execute_task</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/globalsnow/lib/python3.10/site-packages/dask/core.py:119,</span> in <span class="ni">_execute_task</span><span class="nt">(arg, cache, dsk)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>     <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="c1"># Note: Don&#39;t assign the subtask results to a variable. numpy detects</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="c1"># temporaries by their reference count and can execute certain</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="c1"># operations in-place.</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_execute_task</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">elif</span> <span class="ow">not</span> <span class="n">ishashable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">return</span> <span class="n">arg</span>

<span class="nn">File &lt;__array_function__ internals&gt;:180,</span> in <span class="ni">where</span><span class="nt">(*args, **kwargs)</span>

<span class="ne">MemoryError</span>: Unable to allocate 365. GiB for an array with shape (60265, 79, 143, 144) and data type float32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dset_dict = search_data(cmip_in, t_res, list_models, year_range)</span>
<span class="c1"># dset_dict = dict()</span>
<span class="c1"># for model in list_models:</span>
<span class="c1">#     cmip_file_in = glob(&#39;{}/*{}_{}_{}*&#39;.format(cmip_in, t_res[0], model, experiment_id[0]))</span>
<span class="c1">#     if len(cmip_file_in) != 0:</span>
<span class="c1">#         dset_dict[model] = xr.open_mfdataset(sorted(cmip_file_in), combine=&#39;nested&#39;, compat=&#39;override&#39;, use_cftime=True)</span>
<span class="c1">#         # select only years needed for analysis</span>
<span class="c1">#         dset_dict[model] = dset_dict[model].sel(time = dset_dict[model][&#39;time&#39;].dt.year.isin(year_range)).squeeze()</span>
<span class="c1">#         # shift longitude to be from -180 to 180</span>
<span class="c1">#         dset_dict[model] = dset_dict[model].assign_coords(lon=(((dset_dict[model][&#39;lon&#39;] + 180) % 360) - 180)).sortby(&#39;lon&#39;).sortby(&#39;time&#39;)</span>
<span class="c1">#     else:</span>
<span class="c1">#         continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now = datetime.utcnow()</span>
<span class="c1"># for model in dset_dict.keys():</span>
<span class="c1"># # </span>
<span class="c1">#     for var_id in dset_dict[model].keys():</span>
         
<span class="c1">#         if var_id == &#39;prsn&#39;:</span>
<span class="c1">#             dset_dict[model][var_id] = dset_dict[model][var_id]*3600</span>
<span class="c1">#             dset_dict[model][var_id] = dset_dict[model][var_id].assign_attrs({&#39;standard_name&#39;: &#39;snowfall_flux&#39;,</span>
<span class="c1">#     &#39;long_name&#39;: &#39;Snowfall Flux&#39;,</span>
<span class="c1">#     &#39;comment&#39;: &#39;At surface; includes precipitation of all forms of water in the solid phase&#39;,</span>
<span class="c1">#     &#39;units&#39;: &#39;mm h-1&#39;,</span>
<span class="c1">#     &#39;original_units&#39;: &#39;kg m-2 s-1&#39;,</span>
<span class="c1">#     &#39;history&#39;: &quot;{}Z altered by F. Hellmuth: Converted units from &#39;kg m-2 s-1&#39; to &#39;mm h-1&#39;.&quot;.format(now.strftime(&quot;%d/%m/%Y %H:%M:%S&quot;)),</span>
<span class="c1">#     &#39;cell_methods&#39;: &#39;area: time: mean&#39;,</span>
<span class="c1">#     &#39;cell_measures&#39;: &#39;area: areacella&#39;})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Rename datasets with different naming convention for constant hyam</span>
<span class="c1"># for model in dset_dict.keys():</span>
<span class="c1">#     if (&#39;a&#39; in list(dset_dict[model].keys())) == True:</span>
<span class="c1">#         dset_dict[model] = dset_dict[model].rename({&#39;a&#39;:&#39;ap&#39;, &#39;a_bnds&#39;: &#39;ap_bnds&#39;})</span>
<span class="c1">#     if model == &#39;IPSL-CM6A-LR&#39;:</span>
<span class="c1">#         dset_dict[model] = dset_dict[model].rename({&#39;presnivs&#39;:&#39;plev&#39;})</span>
<span class="c1">#     if model == &#39;IPSL-CM5A2-INCA&#39;:</span>
<span class="c1">#         dset_dict[model] = dset_dict[model].rename({&#39;lev&#39;:&#39;plev&#39;})</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in dset_dict.keys():</span>
<span class="c1">#     for var_id in dset_dict[model].keys():#[&#39;clw&#39;, &#39;cli&#39;]:</span>
<span class="c1">#         if var_id == &#39;clw&#39; or var_id == &#39;cli&#39;:</span>
<span class="c1">#             # Convert the model level to isobaric levels</span>
<span class="c1">#             #### ap, b, ps, p0</span>
<span class="c1">#             if (&#39;ap&#39; in list(dset_dict[model].keys())) == True and \</span>
<span class="c1">#                 (&#39;ps&#39; in list(dset_dict[model].keys())) == True and \</span>
<span class="c1">#                 (&#39;p0&#39; in list(dset_dict[model].keys())) == True:</span>
<span class="c1">#                 if (&#39;lev&#39; in list(dset_dict[model][var_id].coords)) == True and \</span>
<span class="c1">#                     (&#39;lev&#39; in list(dset_dict[model][&#39;ap&#39;].coords)) == True and \</span>
<span class="c1">#                     (&#39;lev&#39; in list(dset_dict[model][&#39;b&#39;].coords)) == True:</span>
<span class="c1">#                         print(model, var_id, &#39;lev, ap, ps, p0&#39;)</span>
<span class="c1">#                         # dset_dict[model][var_id] = gc.interpolation.interp_hybrid_to_pressure(data = dset_dict[model][var_id],</span>
<span class="c1">#                         #                                                                                 ps   = dset_dict[model][&#39;ps&#39;], </span>
<span class="c1">#                         #                                                                                 hyam = dset_dict[model][&#39;ap&#39;], </span>
<span class="c1">#                         #                                                                                 hybm = dset_dict[model][&#39;b&#39;], </span>
<span class="c1">#                         #                                                                                 p0   = dset_dict[model][&#39;p0&#39;], </span>
<span class="c1">#                         #                                                                                 new_levels=new_levels,</span>
<span class="c1">#                         #                                                                                 lev_dim=&#39;lev&#39;)</span>
<span class="c1">#                         dset_dict[model][&#39;plev&#39;] = dset_dict[model][&#39;ap&#39;]*dset_dict[model][&#39;p0&#39;] + dset_dict[model][&#39;b&#39;]*dset_dict[model][&#39;ps&#39;]</span>
<span class="c1">#                         dset_dict[model][&#39;plev&#39;] = dset_dict[model][&#39;plev&#39;].transpose(&#39;time&#39;, &#39;lev&#39;,&#39;lat&#39;,&#39;lon&#39;)</span>
                
<span class="c1">#                 if (&#39;plev&#39; in list(dset_dict[model][var_id].coords)) == True:</span>
<span class="c1">#                     print(model, var_id, &#39;variable on pressure levels&#39;, )</span>
<span class="c1">#                 # if (&#39;lev&#39; in list(dset_dict[model][var_id].coords)) == True and \</span>
<span class="c1">#                 #     (&#39;lev&#39; in list(dset_dict[model][&#39;ap&#39;].coords)) == False and \</span>
<span class="c1">#                 #     (&#39;lev&#39; in list(dset_dict[model][&#39;b&#39;].coords)) == False:</span>
<span class="c1">#                 #         print(model, &#39;variable on pressure levels&#39;, &#39;lev, ap, ps,&#39;)</span>
<span class="c1">#             # Convert the model level to isobaric levels</span>
<span class="c1">#             #### ap, b, p0</span>
<span class="c1">#             if (&#39;ap&#39; in list(dset_dict[model].keys())) == True and \</span>
<span class="c1">#                 (&#39;ps&#39; in list(dset_dict[model].keys())) == True and \</span>
<span class="c1">#                 (&#39;p0&#39; in list(dset_dict[model].keys())) == False:</span>
<span class="c1">#                 if (&#39;lev&#39; in list(dset_dict[model][var_id].coords)) == True and \</span>
<span class="c1">#                     (&#39;lev&#39; in list(dset_dict[model][&#39;ap&#39;].coords)) == True and \</span>
<span class="c1">#                     (&#39;lev&#39; in list(dset_dict[model][&#39;b&#39;].coords)) == True:</span>
<span class="c1">#                         print(model,var_id, &#39;lev, ap, ps,&#39;)</span>
<span class="c1">#                         # dset_dict[model][var_id] = gc.interpolation.interp_hybrid_to_pressure(data = dset_dict[model][var_id],</span>
<span class="c1">#                         #                                                                                 ps   = dset_dict[model][&#39;ps&#39;], </span>
<span class="c1">#                         #                                                                                 hyam = dset_dict[model][&#39;ap&#39;], </span>
<span class="c1">#                         #                                                                                 hybm = dset_dict[model][&#39;b&#39;], </span>
<span class="c1">#                         #                                                                                 new_levels=new_levels,</span>
<span class="c1">#                         #                                                                                 lev_dim=&#39;lev&#39;)</span>
<span class="c1">#                         dset_dict[model][&#39;plev&#39;] = dset_dict[model][&#39;ap&#39;] + dset_dict[model][&#39;b&#39;]*dset_dict[model][&#39;ps&#39;]</span>
<span class="c1">#                         dset_dict[model][&#39;plev&#39;] = dset_dict[model][&#39;plev&#39;].transpose(&#39;time&#39;, &#39;lev&#39;,&#39;lat&#39;,&#39;lon&#39;)</span>
                
<span class="c1">#                 if (&#39;plev&#39; in list(dset_dict[model][var_id].coords)) == True:</span>
<span class="c1">#                     print(model, var_id, &#39;variable on pressure levels&#39;, )</span>
                
<span class="c1">#             if (&#39;b&#39; in list(dset_dict[model].keys())) == True and \</span>
<span class="c1">#                 (&#39;orog&#39; in list(dset_dict[model].keys())) == True:</span>
<span class="c1">#                 if (&#39;lev&#39; in list(dset_dict[model][var_id].coords)) == True and \</span>
<span class="c1">#                     (&#39;lev&#39; in list(dset_dict[model][&#39;pfull&#39;].coords)) == True:</span>
<span class="c1">#                         print(model, &#39;hybrid height coordinate&#39;)</span>
                
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for model in dset_dict.keys():</span>
    
<span class="c1">#     if (&#39;plev&#39; in list(dset_dict[model].keys())) == True:</span>
<span class="c1">#         print(model, &#39;plev&#39;)</span>
<span class="c1">#         _lwp = xr.DataArray(data=da.full(shape=dset_dict[model][&#39;clw&#39;].shape,fill_value=np.nan),</span>
<span class="c1">#                                 dims=dset_dict[model][&#39;clw&#39;].dims,</span>
<span class="c1">#                                 coords=dset_dict[model][&#39;clw&#39;].coords)</span>
<span class="c1">#         # lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
<span class="c1">#         for i in range(len(dset_dict[model][&#39;lev&#39;])-1):</span>
<span class="c1">#             # calculate pressure difference between two levels</span>
<span class="c1">#             dp = (dset_dict[model][&#39;plev&#39;].isel(lev=i) - dset_dict[model][&#39;plev&#39;].isel(lev=i+1))</span>
<span class="c1">#             # calculate mean liquid water content between two layers</span>
<span class="c1">#             dlwc = (dset_dict[model][&#39;clw&#39;].isel(lev=i) + dset_dict[model][&#39;clw&#39;].isel(lev=i+1))/2</span>
<span class="c1">#             # calculate liquid water path between two layers</span>
<span class="c1">#             _lwp[:,i,:,:] = dp[:,:,:]/9.81 * dlwc[:,:,:]</span>
        
<span class="c1">#             # sum over all layers to ge the liquid water path in the atmospheric column</span>
<span class="c1">#             dset_dict[model][&#39;lwp&#39;] = _lwp.sum(dim=&#39;lev&#39;,skipna=True)</span>
            
<span class="c1">#             # assign attributes to data array</span>
<span class="c1">#             dset_dict[model][&#39;lwp&#39;] = dset_dict[model][&#39;lwp&#39;].assign_attrs(dset_dict[model][&#39;clw&#39;].attrs)</span>
<span class="c1">#             dset_dict[model][&#39;lwp&#39;] = dset_dict[model][&#39;lwp&#39;].assign_attrs({&#39;long_name&#39;:&#39;Liquid Water Path&#39;, </span>
<span class="c1">#                                                                             &#39;units&#39; : &#39;kg m-2&#39;,</span>
<span class="c1">#                                                                                 &#39;mipTable&#39;:&#39;&#39;, &#39;out_name&#39;: &#39;lwp&#39;,</span>
<span class="c1">#                                                                                 &#39;standard_name&#39;: &#39;atmosphere_mass_content_of_cloud_liquid_water&#39;,</span>
<span class="c1">#                                                                                 &#39;title&#39;: &#39;Liquid Water Path&#39;,</span>
<span class="c1">#                                                                                 &#39;variable_id&#39;: &#39;lwp&#39;, &#39;original_units&#39;: &#39;kg/kg&#39;,</span>
<span class="c1">#                                                                                 &#39;history&#39;: &quot;{}Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate lwp with hydrostatic equation.&quot;.format(now.strftime(&quot;%d/%m/%Y %H:%M:%S&quot;))})</span>
<span class="c1">#         # when ice water path does not exist</span>
<span class="c1">#         if (&#39;clivi&#39; in list(dset_dict[model].keys())) == False:</span>
<span class="c1">#             _iwp = xr.DataArray(data=da.full(shape=dset_dict[model][&#39;cli&#39;].shape,fill_value=np.nan),</span>
<span class="c1">#                                     dims=dset_dict[model][&#39;cli&#39;].dims,</span>
<span class="c1">#                                     coords=dset_dict[model][&#39;cli&#39;].coords)</span>
<span class="c1">#             # lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
<span class="c1">#             for i in range(len(dset_dict[model][&#39;lev&#39;])-1):</span>
<span class="c1">#                 # calculate pressure difference between two levels</span>
<span class="c1">#                 dp = (dset_dict[model][&#39;plev&#39;].isel(lev=i) - dset_dict[model][&#39;plev&#39;].isel(lev=i+1))</span>
<span class="c1">#                 # calculate mean liquid water content between two layers</span>
<span class="c1">#                 diwc = (dset_dict[model][&#39;cli&#39;].isel(lev=i) + dset_dict[model][&#39;cli&#39;].isel(lev=i+1))/2</span>
<span class="c1">#                 # calculate liquid water path between two layers</span>
<span class="c1">#                 _iwp[:,i,:,:] = dp[:,:,:]/9.81 * diwc[:,:,:]</span>
            
                
<span class="c1">#                 # sum over all layers to ge the Ice water path in the atmospheric column</span>
<span class="c1">#                 dset_dict[model][&#39;clivi&#39;] = _iwp.sum(dim=&#39;lev&#39;,skipna=True)</span>
                
<span class="c1">#                 # assign attributes to data array</span>
<span class="c1">#                 dset_dict[model][&#39;clivi&#39;] = dset_dict[model][&#39;clivi&#39;].assign_attrs(dset_dict[model][&#39;cli&#39;].attrs)</span>
<span class="c1">#                 dset_dict[model][&#39;clivi&#39;] = dset_dict[model][&#39;clivi&#39;].assign_attrs({&#39;long_name&#39;:&#39;Ice Water Path&#39;, </span>
<span class="c1">#                                                                                 &#39;units&#39; : &#39;kg m-2&#39;,</span>
<span class="c1">#                                                                                     &#39;mipTable&#39;:&#39;&#39;, &#39;out_name&#39;: &#39;clivi&#39;,</span>
<span class="c1">#                                                                                     &#39;standard_name&#39;: &#39;atmosphere_mass_content_of_cloud_ice_water&#39;,</span>
<span class="c1">#                                                                                     &#39;title&#39;: &#39;Ice Water Path&#39;,</span>
<span class="c1">#                                                                                     &#39;variable_id&#39;: &#39;clivi&#39;, &#39;original_units&#39;: &#39;kg/kg&#39;,</span>
<span class="c1">#                                                                                     &#39;history&#39;: &quot;{}Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate clivi with hydrostatic equation.&quot;.format(now.strftime(&quot;%d/%m/%Y %H:%M:%S&quot;))})</span>
            
<span class="c1">#     if (&#39;plev&#39; in list(dset_dict[model].coords)) == True:</span>
<span class="c1">#         print(model, &#39;plev coord&#39;)</span>
<span class="c1">#         _lwp = xr.DataArray(data=da.full(shape=dset_dict[model][&#39;clw&#39;].shape,fill_value=np.nan),</span>
<span class="c1">#                                 dims=dset_dict[model][&#39;clw&#39;].dims,</span>
<span class="c1">#                                 coords=dset_dict[model][&#39;clw&#39;].coords)</span>
<span class="c1">#         # lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
<span class="c1">#         for i in range(len(dset_dict[model][&#39;plev&#39;])-1):</span>
<span class="c1">#             # calculate pressure difference between two levels</span>
<span class="c1">#             dp = (dset_dict[model][&#39;plev&#39;].isel(plev=i) - dset_dict[model][&#39;plev&#39;].isel(plev=i+1))</span>
<span class="c1">#             # calculate mean liquid water content between two layers</span>
<span class="c1">#             dlwc = (dset_dict[model][&#39;clw&#39;].isel(plev=i) + dset_dict[model][&#39;clw&#39;].isel(plev=i+1))/2</span>
<span class="c1">#             # calculate liquid water path between two layers</span>
<span class="c1">#             _lwp[:,i,:,:] = dp/9.81 * dlwc[:,:,:]</span>
        
<span class="c1">#             # sum over all layers to ge the liquid water path in the atmospheric column</span>
<span class="c1">#             dset_dict[model][&#39;lwp&#39;] = _lwp.sum(dim=&#39;plev&#39;,skipna=True)</span>
            
<span class="c1">#             # assign attributes to data array</span>
<span class="c1">#             dset_dict[model][&#39;lwp&#39;] = dset_dict[model][&#39;lwp&#39;].assign_attrs(dset_dict[model][&#39;clw&#39;].attrs)</span>
<span class="c1">#             dset_dict[model][&#39;lwp&#39;] = dset_dict[model][&#39;lwp&#39;].assign_attrs({&#39;long_name&#39;:&#39;Liquid Water Path&#39;, </span>
<span class="c1">#                                                                             &#39;units&#39; : &#39;kg m-2&#39;,</span>
<span class="c1">#                                                                                 &#39;mipTable&#39;:&#39;&#39;, &#39;out_name&#39;: &#39;lwp&#39;,</span>
<span class="c1">#                                                                                 &#39;standard_name&#39;: &#39;atmosphere_mass_content_of_cloud_liquid_water&#39;,</span>
<span class="c1">#                                                                                 &#39;title&#39;: &#39;Liquid Water Path&#39;,</span>
<span class="c1">#                                                                                 &#39;variable_id&#39;: &#39;lwp&#39;, &#39;original_units&#39;: &#39;kg/kg&#39;,</span>
<span class="c1">#                                                                                 &#39;history&#39;: &quot;{}Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate lwp with hydrostatic equation.&quot;.format(now.strftime(&quot;%d/%m/%Y %H:%M:%S&quot;))})</span>
<span class="c1">#         # when ice water path does not exist</span>
<span class="c1">#         if (&#39;clivi&#39; in list(dset_dict[model].keys())) == False:</span>
<span class="c1">#             _iwp = xr.DataArray(data=da.full(shape=dset_dict[model][&#39;cli&#39;].shape,fill_value=np.nan),</span>
<span class="c1">#                                     dims=dset_dict[model][&#39;cli&#39;].dims,</span>
<span class="c1">#                                     coords=dset_dict[model][&#39;cli&#39;].coords)</span>
<span class="c1">#             # lev2 is the atmospheric pressure, lower in the atmosphere than lev. Sigma-pressure coordinates are from 1 to 0, with 1 at the surface</span>
<span class="c1">#             for i in range(len(dset_dict[model][&#39;plev&#39;])-1):</span>
<span class="c1">#                 # calculate pressure difference between two levels</span>
<span class="c1">#                 dp = (dset_dict[model][&#39;plev&#39;].isel(plev=i) - dset_dict[model][&#39;plev&#39;].isel(plev=i+1))</span>
<span class="c1">#                 # calculate mean liquid water content between two layers</span>
<span class="c1">#                 diwc = (dset_dict[model][&#39;cli&#39;].isel(plev=i) + dset_dict[model][&#39;cli&#39;].isel(plev=i+1))/2</span>
<span class="c1">#                 # calculate liquid water path between two layers</span>
<span class="c1">#                 _iwp[:,i,:,:] = dp/9.81 * diwc[:,:,:]</span>
            
                
<span class="c1">#                 # sum over all layers to ge the Ice water path in the atmospheric column</span>
<span class="c1">#                 dset_dict[model][&#39;clivi&#39;] = _iwp.sum(dim=&#39;plev&#39;,skipna=True)</span>
                
<span class="c1">#                 # assign attributes to data array</span>
<span class="c1">#                 dset_dict[model][&#39;clivi&#39;] = dset_dict[model][&#39;clivi&#39;].assign_attrs(dset_dict[model][&#39;clw&#39;].attrs)</span>
<span class="c1">#                 dset_dict[model][&#39;clivi&#39;] = dset_dict[model][&#39;clivi&#39;].assign_attrs({&#39;long_name&#39;:&#39;Ice Water Path&#39;, </span>
<span class="c1">#                                                                                 &#39;units&#39; : &#39;kg m-2&#39;,</span>
<span class="c1">#                                                                                     &#39;mipTable&#39;:&#39;&#39;, &#39;out_name&#39;: &#39;clivi&#39;,</span>
<span class="c1">#                                                                                     &#39;standard_name&#39;: &#39;atmosphere_mass_content_of_cloud_ice_water&#39;,</span>
<span class="c1">#                                                                                     &#39;title&#39;: &#39;Ice Water Path&#39;,</span>
<span class="c1">#                                                                                     &#39;variable_id&#39;: &#39;clivi&#39;, &#39;original_units&#39;: &#39;kg/kg&#39;,</span>
<span class="c1">#                                                                                     &#39;history&#39;: &quot;{}Z altered by F. Hellmuth: Interpolate data from hybrid-sigma levels to isobaric levels with P=a*p0 + b*psfc. Calculate clivi with hydrostatic equation.&quot;.format(now.strftime(&quot;%d/%m/%Y %H:%M:%S&quot;))})</span>
            
</pre></div>
</div>
</div>
</div>
<img src="https://drive.google.com/uc?id=1zb0LHvipx8JOXLLrCxzYToJM7eNK4eaw"  height="100" />
<img src="https://reliance.rohub.org/static/media/Reliance-logo.433dc2e9.png"  height="100" />
<img src="https://www.uio.no/vrtx/decorating/resources/dist/src2/images/footer/uio-logo-en.svg"  height="100" />
<img src="https://erc.europa.eu/sites/default/files/logo_0.png"  height="100" />
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./cmip"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Example with CMIP6 models (100 - 500 km)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#table-of-contents">Table of Contents</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-a-id-introduction-a">1. Introduction <a id="introduction"></a></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#data-wrangling-a-id-data-wrangling-a">2. Data Wrangling <a id="data_wrangling"></a></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#organize-my-data">Organize my data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-python-packages">Import python packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#open-cmip6-variables">Open CMIP6 variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#search-corresponding-data">Search corresponding data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-attributes-to-the-variables">Assign attributes to the variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-from-cmip6-hybrid-sigma-pressure-levels-to-isobaric-pressure-levels">Interpolate from CMIP6 hybrid sigma-pressure levels to isobaric pressure levels</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-liquid-water-path-from-content">Calculate liquid water path from content</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Franziska Hellmuth
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>